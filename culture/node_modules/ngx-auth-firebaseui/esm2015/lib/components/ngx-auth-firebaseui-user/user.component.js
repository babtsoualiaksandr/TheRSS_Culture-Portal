import { __awaiter, __decorate, __param } from "tslib";
import { Component, EventEmitter, forwardRef, Inject, Input, Output } from '@angular/core';
import { AngularFireAuth } from '@angular/fire/auth';
import { FormControl, FormGroup, Validators } from '@angular/forms';
import { AuthProcessService } from '../../services';
import { FirestoreSyncService } from '../../services';
import { EMAIL_REGEX, PHONE_NUMBER_REGEX } from '..';
import { NgxAuthFirebaseUIConfigToken } from '../../tokens';
let UserComponent = class UserComponent {
    constructor(auth, authProcess, fireStoreService, config) {
        this.auth = auth;
        this.authProcess = authProcess;
        this.fireStoreService = fireStoreService;
        this.config = config;
        this.canLogout = true;
        this.canEditAccount = true;
        this.canDeleteAccount = true;
        // tslint:disable-next-line:no-output-on-prefix
        this.onSignOut = new EventEmitter();
        // tslint:disable-next-line:no-output-on-prefix
        this.onAccountEdited = new EventEmitter();
        // tslint:disable-next-line:no-output-on-prefix
        this.onAccountDeleted = new EventEmitter();
    }
    changeEditMode() {
        this.editMode = !this.editMode;
        this.editMode ? this.initUpdateFormGroup() : this.reset();
    }
    reset() {
        this.updateFormGroup.reset();
        this.updateFormGroup.disable();
        this.updateFormGroup = null;
    }
    save() {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.updateFormGroup.dirty) {
                const user = this.auth.auth.currentUser;
                // ngx-auth-firebaseui-user.updateProfile()
                // ngx-auth-firebaseui-user.updateEmail()
                // console.log('form = ', this.updateFormGroup);
                const snackBarMsg = [];
                try {
                    if (this.updateNameFormControl.dirty) {
                        yield user.updateProfile({ displayName: this.updateNameFormControl.value });
                        snackBarMsg.push(`your name has been updated to ${user.displayName}`);
                    }
                    if (this.updateEmailFormControl.dirty) {
                        yield user.updateEmail(this.updateEmailFormControl.value);
                        snackBarMsg.push(`your email has been updated to ${user.email}`);
                    }
                    if (this.updatePhoneNumberFormControl.dirty) {
                        yield user.updatePhoneNumber(this.updatePhoneNumberFormControl.value);
                        console.log('phone number = ', this.updatePhoneNumberFormControl.value);
                        snackBarMsg.push(`your phone number has been updated to ${user.phoneNumber}`);
                    }
                    if (this.config.enableFirestoreSync) {
                        yield this.fireStoreService.updateUserData(this.authProcess.parseUserInfo(user));
                    }
                }
                catch (error) {
                    this.authProcess.showToast(error && error.message ? error.message : error);
                    console.error(error);
                }
                if (snackBarMsg.length > 0) {
                    this.authProcess.showToast(snackBarMsg.join('\\n'));
                }
                // this.updateFormGroup.reset();
            }
            this.editMode = false;
        });
    }
    signOut() {
        this.auth.auth.signOut()
            .then(() => this.onSignOut.emit())
            .catch(e => console.error('An error happened while signing out!', e));
    }
    /**
     * Delete the account of the current firebase ngx-auth-firebaseui-user
     *
     * On Success, emit the <onAccountDeleted> event and toast a msg!#
     * Otherwise, log the and toast and error msg!
     *
     */
    deleteAccount() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const user = this.auth.auth.currentUser;
                // await this.authProcess.deleteAccount();
                yield this.auth.auth.currentUser.delete();
                // if (this.config.enableFirestoreSync) {
                yield this.fireStoreService.deleteUserData(user.uid);
                // }
                this.onAccountDeleted.emit();
                this.editMode = false;
                console.log('Your account has been successfully deleted!');
                this.authProcess.showToast('Your account has been successfully deleted!');
            }
            catch (error) {
                console.log('Error while delete user account', error);
                this.authProcess.showToast(`Error occurred while deleting your account: ${error.message}`);
            }
        });
    }
    initUpdateFormGroup() {
        const currentUser = this.auth.auth.currentUser;
        this.updateFormGroup = new FormGroup({
            name: this.updateNameFormControl = new FormControl({ value: currentUser.displayName, disabled: this.editMode }, [
                Validators.required,
                Validators.minLength(this.config.nameMinLength),
                Validators.maxLength(this.config.nameMaxLength)
            ]),
            email: this.updateEmailFormControl = new FormControl({ value: currentUser.email, disabled: this.editMode }, [
                Validators.required,
                Validators.pattern(EMAIL_REGEX)
            ]),
            phoneNumber: this.updatePhoneNumberFormControl = new FormControl({ value: currentUser.phoneNumber, disabled: this.editMode }, [Validators.pattern(PHONE_NUMBER_REGEX)])
        });
        this.updateFormGroup.enable();
    }
};
UserComponent.ctorParameters = () => [
    { type: AngularFireAuth },
    { type: AuthProcessService },
    { type: FirestoreSyncService },
    { type: undefined, decorators: [{ type: Inject, args: [forwardRef(() => NgxAuthFirebaseUIConfigToken),] }] }
];
__decorate([
    Input()
], UserComponent.prototype, "editMode", void 0);
__decorate([
    Input()
], UserComponent.prototype, "canLogout", void 0);
__decorate([
    Input()
], UserComponent.prototype, "canEditAccount", void 0);
__decorate([
    Input()
], UserComponent.prototype, "canDeleteAccount", void 0);
__decorate([
    Input()
], UserComponent.prototype, "appearance", void 0);
__decorate([
    Output()
], UserComponent.prototype, "onSignOut", void 0);
__decorate([
    Output()
], UserComponent.prototype, "onAccountEdited", void 0);
__decorate([
    Output()
], UserComponent.prototype, "onAccountDeleted", void 0);
UserComponent = __decorate([
    Component({
        selector: 'ngx-auth-firebaseui-user',
        template: "<div *ngIf=\"auth.authState| async as user; then authenticated else none\">\n\n</div>\n\n<ng-template #authenticated>\n  <mat-card *ngIf=\"auth.user | async as user\">\n    <!--<form [formGroup]=\"updateFormGroup\" >-->\n    <!--card header-->\n    <mat-card-header fxLayout=\"column\" fxLayoutAlign=\"center center\">\n\n      <img [src]=\"authProcess?.getUserPhotoUrl()\" mat-card-avatar>\n\n      <div *ngIf=\"user.emailVerified; then emailVerified else emailNotVerified\"></div>\n      <ng-template #emailVerified>\n        <mat-icon color=\"primary\"\n                  matTooltip=\"email is verified\"\n                  matTooltipPosition=\"after\">\n          verified_user\n        </mat-icon>\n      </ng-template>\n      <ng-template #emailNotVerified>\n        <mat-icon color=\"warn\"\n                  matTooltip=\"email is not verified\"\n                  matTooltipPosition=\"after\">\n          warning\n        </mat-icon>\n      </ng-template>\n\n    </mat-card-header>\n\n    <!--card content-->\n    <mat-card-content *ngIf=\"editMode; then edit else readonly\">\n    </mat-card-content>\n\n    <ng-template #edit>\n      <form (submit)=\"save()\" [formGroup]=\"updateFormGroup\">\n\n        <mat-card-content fxLayout=\"column\" fxLayoutAlign=\"center center\">\n          <div fxLayoutAlign=\"center\">\n            <button (click)=\"changeEditMode()\" class=\"edit-button\" color=\"warn\"\n                    mat-raised-button>\n              cancel\n            </button>\n          </div>\n\n          <!--name-->\n          <mat-form-field [appearance]=\"appearance\" class=\"full-width\">\n            <mat-label>Name</mat-label>\n            <input [formControl]=\"updateNameFormControl\"\n                   matInput\n                   placeholder=\"Name\">\n            <mat-icon matSuffix>person</mat-icon>\n            <mat-hint align=\"end\" aria-live=\"polite\"> {{ updateNameFormControl.value?.length }}\n              / {{ config.nameMaxLength }} </mat-hint>\n            <mat-error *ngIf=\"updateNameFormControl.hasError('required')\">\n              Name is required\n            </mat-error>\n          </mat-form-field>\n\n          <!--email-->\n          <mat-form-field [appearance]=\"appearance\" class=\"full-width\">\n            <mat-label>E-mail</mat-label>\n            <input [formControl]=\"updateEmailFormControl\"\n                   matInput\n                   placeholder=\"E-mail\">\n            <mat-icon matSuffix>email</mat-icon>\n            <mat-error *ngIf=\"updateEmailFormControl.hasError('required')\">\n              E-mail is required {{updateEmailFormControl.value}}\n            </mat-error>\n            <mat-error *ngIf=\"updateEmailFormControl.hasError('pattern')\">\n              Please enter a valid e-mail address {{updateEmailFormControl.value}}\n            </mat-error>\n          </mat-form-field>\n\n          <!--phone number-->\n          <mat-form-field *ngIf=\"false\" [appearance]=\"appearance\" class=\"full-width\">\n            <mat-label>Phone number</mat-label>\n            <input [formControl]=\"updatePhoneNumberFormControl\"\n                   matInput\n                   placeholder=\"Phone number\"\n                   type=\"tel\">\n            <mat-icon matSuffix>phone</mat-icon>\n            <mat-hint align=\"end\" aria-live=\"polite\">\n              The phone number is international. Therefore, it should start with a + sign or 00,\n              followed by the country code, - and national number e.g: +49-12345678 or 0041-1234567890\n\n              NOTE : the phone number must be a valid phone credential !!\n            </mat-hint>\n            <mat-error *ngIf=\"updatePhoneNumberFormControl.hasError('pattern')\">\n              Please enter a valid phone number\n            </mat-error>\n          </mat-form-field>\n\n        </mat-card-content>\n\n        <mat-card-actions fxLayout=\"column\">\n          <button color=\"primary\"\n                  mat-button\n                  type=\"submit\">\n            Save changes\n          </button>\n        </mat-card-actions>\n      </form>\n    </ng-template>\n\n    <ng-template #readonly>\n      <div fxLayoutAlign=\"center\">\n        <button (click)=\"changeEditMode()\" class=\"edit-button\" color=\"primary\"\n                mat-raised-button>\n          edit\n        </button>\n      </div>\n\n      <!--name-->\n      <mat-form-field [appearance]=\"appearance\" class=\"full-width\">\n        <mat-label>Name</mat-label>\n        <input [disabled]=\"!editMode\"\n               [value]=\"user.displayName\"\n               matInput\n               placeholder=\"Name\">\n        <mat-icon color=\"primary\" matSuffix>person</mat-icon>\n      </mat-form-field>\n\n      <!--email-->\n      <mat-form-field [appearance]=\"appearance\" class=\"full-width\">\n        <mat-label>E-mail</mat-label>\n        <input [disabled]=\"!editMode\"\n               [value]=\"user.email\" matInput\n               placeholder=\"E-mail\">\n        <mat-icon color=\"primary\" matSuffix>email</mat-icon>\n      </mat-form-field>\n\n      <!--phone number-->\n      <mat-form-field *ngIf=\"false\" [appearance]=\"appearance\" class=\"full-width\">\n        <mat-label>Phone number</mat-label>\n        <input [disabled]=\"!editMode\"\n               [value]=\"user.phoneNumber\"\n               matInput\n               placeholder=\"Phone number\">\n        <mat-icon color=\"primary\" matSuffix>phone</mat-icon>\n      </mat-form-field>\n\n      <mat-card-actions fxLayout=\"column\">\n        <button (click)=\"signOut()\" *ngIf=\"canLogout\" color=\"primary\" mat-button>Sign out</button>\n        <button (click)=\"deleteAccount()\" *ngIf=\"canDeleteAccount\" color=\"warn\" mat-button>Delete account</button>\n      </mat-card-actions>\n\n    </ng-template>\n\n  </mat-card>\n\n</ng-template>\n\n\n<ng-template #none>\n  <mat-card class=\"none-card\" fxLayout=\"row\" fxLayoutAlign=\"center center\">\n    <mat-card-content fxLayout=\"row\" fxLayoutAlign=\"center center\">\n      <mat-icon color=\"accent\">warning</mat-icon>\n      <span>You are not logged in!</span>\n    </mat-card-content>\n  </mat-card>\n</ng-template>\n",
        styles: [".edit-button{margin:1rem}.full-width{width:100%}.cut-text{text-overflow:ellipsis;overflow:hidden;white-space:nowrap}.none-card{min-height:430px}.none-card span{font-size:24px;text-align:center;color:rgba(0,0,0,.54)}"]
    }),
    __param(3, Inject(forwardRef(() => NgxAuthFirebaseUIConfigToken)))
], UserComponent);
export { UserComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtYXV0aC1maXJlYmFzZXVpLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvbmd4LWF1dGgtZmlyZWJhc2V1aS11c2VyL3VzZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUMsU0FBUyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDekYsT0FBTyxFQUFDLGVBQWUsRUFBQyxNQUFNLG9CQUFvQixDQUFDO0FBQ25ELE9BQU8sRUFBQyxXQUFXLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBRWxFLE9BQU8sRUFBQyxrQkFBa0IsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ2xELE9BQU8sRUFBQyxvQkFBb0IsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ3BELE9BQU8sRUFBQyxXQUFXLEVBQUUsa0JBQWtCLEVBQUMsTUFBTSxJQUFJLENBQUM7QUFFbkQsT0FBTyxFQUFDLDRCQUE0QixFQUFDLE1BQU0sY0FBYyxDQUFDO0FBUTFELElBQWEsYUFBYSxHQUExQixNQUFhLGFBQWE7SUFtQ3hCLFlBQ1MsSUFBcUIsRUFDckIsV0FBK0IsRUFDOUIsZ0JBQXNDLEVBQ2lCLE1BQStCO1FBSHZGLFNBQUksR0FBSixJQUFJLENBQWlCO1FBQ3JCLGdCQUFXLEdBQVgsV0FBVyxDQUFvQjtRQUM5QixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQXNCO1FBQ2lCLFdBQU0sR0FBTixNQUFNLENBQXlCO1FBakNoRyxjQUFTLEdBQUcsSUFBSSxDQUFDO1FBR2pCLG1CQUFjLEdBQUcsSUFBSSxDQUFDO1FBR3RCLHFCQUFnQixHQUFHLElBQUksQ0FBQztRQUt4QiwrQ0FBK0M7UUFFL0MsY0FBUyxHQUF1QixJQUFJLFlBQVksRUFBRSxDQUFDO1FBRW5ELCtD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QUssRUFBRTtnREFDUztBQUdqQjtJQURDLEtBQUssRUFBRTtxREFDYztBQUd0QjtJQURDLEtBQUssRUFBRTt1REFDZ0I7QUFHeEI7SUFEQyxLQUFLLEVBQUU7aURBQzJCO0FBSW5DO0lBREMsTUFBTSxFQUFFO2dEQUMwQztBQUluRDtJQURDLE1BQU0sRUFBRTtzREFDZ0Q7QUFJekQ7SUFEQyxNQUFNLEVBQUU7dURBQ2lEO0FBM0IvQyxhQUFhO0lBTHpCLFNBQVMsQ0FBQztRQUNULFFBQVEsRUFBRSwwQkFBMEI7UUFDcEMsbWtNQUFvQzs7S0FFckMsQ0FBQztJQXdDRyxXQUFBLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsNEJBQTRCLENBQUMsQ0FBQyxDQUFBO0dBdkM5QyxhQUFhLENBOEp6QjtTQTlKWSxhQUFhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb21wb25lbnQsIEV2ZW50RW1pdHRlciwgZm9yd2FyZFJlZiwgSW5qZWN0LCBJbnB1dCwgT3V0cHV0fSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7QW5ndWxhckZpcmVBdXRofSBmcm9tICdAYW5ndWxhci9maXJlL2F1dGgnO1xuaW1wb3J0IHtGb3JtQ29udHJvbCwgRm9ybUdyb3VwLCBWYWxpZGF0b3JzfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQge1VzZXJ9IGZyb20gJ2ZpcmViYXNlJztcbmltcG9ydCB7QXV0aFByb2Nlc3NTZXJ2aWNlfSBmcm9tICcuLi8uLi9zZXJ2aWNlcyc7XG5pbXBvcnQge0ZpcmVzdG9yZVN5bmNTZXJ2aWNlfSBmcm9tICcuLi8uLi9zZXJ2aWNlcyc7XG5pbXBvcnQge0VNQUlMX1JFR0VYLCBQSE9ORV9OVU1CRVJfUkVHRVh9IGZyb20gJy4uJztcbmltcG9ydCB7TWF0Rm9ybUZpZWxkQXBwZWFyYW5jZX0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvZm9ybS1maWVsZCc7XG5pbXBvcnQge05neEF1dGhGaXJlYmFzZVVJQ29uZmlnVG9rZW59IGZyb20gJy4uLy4uL3Rva2Vucyc7XG5pbXBvcnQge05neEF1dGhGaXJlYmFzZVVJQ29uZmlnfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnbmd4LWF1dGgtZmlyZWJhc2V1aS11c2VyJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3VzZXIuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi91c2VyLmNvbXBvbmVudC5zY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgVXNlckNvbXBvbmVudCB7XG5cbiAgQElucHV0KClcbiAgZWRpdE1vZGU6IGJvb2xlYW47XG5cbiAgQElucHV0KClcbiAgY2FuTG9nb3V0ID0gdHJ1ZTtcblxuICBASW5wdXQoKVxuICBjYW5FZGl0QWNjb3VudCA9IHRydWU7XG5cbiAgQElucHV0KClcbiAgY2FuRGVsZXRlQWNjb3VudCA9IHRydWU7XG5cbiAgQElucHV0KClcbiAgYXBwZWFyYW5jZTogTWF0Rm9ybUZpZWxkQXBwZWFyYW5jZTtcblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tb3V0cHV0LW9uLXByZWZpeFxuICBAT3V0cHV0KClcbiAgb25TaWduT3V0OiBFdmVudEVtaXR0ZXI8dm9pZD4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLW91dHB1dC1vbi1wcmVmaXhcbiAgQE91dHB1dCgpXG4gIG9uQWNjb3VudEVkaXRlZDogRXZlbnRFbWl0dGVyPHZvaWQ+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1vdXRwdXQtb24tcHJlZml4XG4gIEBPdXRwdXQoKVxuICBvbkFjY291bnREZWxldGVkOiBFdmVudEVtaXR0ZXI8dm9pZD4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgdXBkYXRlRm9ybUdyb3VwOiBGb3JtR3JvdXA7XG4gIHVwZGF0ZU5hbWVGb3JtQ29udHJvbDogRm9ybUNvbnRyb2w7XG4gIHVwZGF0ZUVtYWlsRm9ybUNvbnRyb2w6IEZvcm1Db250cm9sO1xuICB1cGRhdGVQaG9uZU51bWJlckZvcm1Db250cm9sOiBGb3JtQ29udHJvbDtcbiAgdXBkYXRlUGFzc3dvcmRGb3JtQ29udHJvbDogRm9ybUNvbnRyb2w7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIGF1dGg6IEFuZ3VsYXJGaXJlQXV0aCxcbiAgICBwdWJsaWMgYXV0aFByb2Nlc3M6IEF1dGhQcm9jZXNzU2VydmljZSxcbiAgICBwcml2YXRlIGZpcmVTdG9yZVNlcnZpY2U6IEZpcmVzdG9yZVN5bmNTZXJ2aWNlLFxuICAgIEBJbmplY3QoZm9yd2FyZFJlZigoKSA9PiBOZ3hBdXRoRmlyZWJhc2VVSUNvbmZpZ1Rva2VuKSkgcHVibGljIGNvbmZpZzogTmd4QXV0aEZpcmViYXNlVUlDb25maWdcbiAgKSB7XG4gIH1cblxuICBjaGFuZ2VFZGl0TW9kZSgpIHtcbiAgICB0aGlzLmVkaXRNb2RlID0gIXRoaXMuZWRpdE1vZGU7XG5cbiAgICB0aGlzLmVkaXRNb2RlID8gdGhpcy5pbml0VXBkYXRlRm9ybUdyb3VwKCkgOiB0aGlzLnJlc2V0KCk7XG4gIH1cblxuICByZXNldCgpIHtcbiAgICB0aGlzLnVwZGF0ZUZvcm1Hcm91cC5yZXNldCgpO1xuICAgIHRoaXMudXBkYXRlRm9ybUdyb3VwLmRpc2FibGUoKTtcbiAgICB0aGlzLnVwZGF0ZUZvcm1Hcm91cCA9IG51bGw7XG4gIH1cblxuICBhc3luYyBzYXZlKCkge1xuICAgIGlmICh0aGlzLnVwZGF0ZUZvcm1Hcm91cC5kaXJ0eSkge1xuICAgICAgY29uc3QgdXNlciA9IHRoaXMuYXV0aC5hdXRoLmN1cnJlbnRVc2VyO1xuICAgICAgLy8gbmd4LWF1dGgtZmlyZWJhc2V1aS11c2VyLnVwZGF0ZVByb2ZpbGUoKVxuICAgICAgLy8gbmd4LWF1dGgtZmlyZWJhc2V1aS11c2VyLnVwZGF0ZUVtYWlsKClcbiAgICAgIC8vIGNvbnNvbGUubG9nKCdmb3JtID0gJywgdGhpcy51cGRhdGVGb3JtR3JvdXApO1xuXG4gICAgICBjb25zdCBzbmFja0Jhck1zZzogc3RyaW5nW10gPSBbXTtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgaWYgKHRoaXMudXBkYXRlTmFtZUZvcm1Db250cm9sLmRpcnR5KSB7XG4gICAgICAgICAgYXdhaXQgdXNlci51cGRhdGVQcm9maWxlKHtkaXNwbGF5TmFtZTogdGhpcy51cGRhdGVOYW1lRm9ybUNvbnRyb2wudmFsdWV9KTtcbiAgICAgICAgICBzbmFja0Jhck1zZy5wdXNoKGB5b3VyIG5hbWUgaGFzIGJlZW4gdXBkYXRlZCB0byAke3VzZXIuZGlzcGxheU5hbWV9YCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy51cGRhdGVFbWFpbEZvcm1Db250cm9sLmRpcnR5KSB7XG4gICAgICAgICAgYXdhaXQgdXNlci51cGRhdGVFbWFpbCh0aGlzLnVwZGF0ZUVtYWlsRm9ybUNvbnRyb2wudmFsdWUpO1xuICAgICAgICAgIHNuYWNrQmFyTXNnLnB1c2goYHlvdXIgZW1haWwgaGFzIGJlZW4gdXBkYXRlZCB0byAke3VzZXIuZW1haWx9YCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy51cGRhdGVQaG9uZU51bWJlckZvcm1Db250cm9sLmRpcnR5KSB7XG4gICAgICAgICAgYXdhaXQgdXNlci51cGRhdGVQaG9uZU51bWJlcih0aGlzLnVwZGF0ZVBob25lTnVtYmVyRm9ybUNvbnRyb2wudmFsdWUpO1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdwaG9uZSBudW1iZXIgPSAnLCB0aGlzLnVwZGF0ZVBob25lTnVtYmVyRm9ybUNvbnRyb2wudmFsdWUpO1xuICAgICAgICAgIHNuYWNrQmFyTXNnLnB1c2goYHlvdXIgcGhvbmUgbnVtYmVyIGhhcyBiZWVuIHVwZGF0ZWQgdG8gJHt1c2VyLnBob25lTnVtYmVyfWApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuY29uZmlnLmVuYWJsZUZpcmVzdG9yZVN5bmMpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLmZpcmVTdG9yZVNlcnZpY2UudXBkYXRlVXNlckRhdGEodGhpcy5hdXRoUHJvY2Vzcy5wYXJzZVVzZXJJbmZvKHVzZXIpKTtcbiAgICAgICAgfVxuXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aGlzLmF1dGhQcm9jZXNzLnNob3dUb2FzdChlcnJvciAmJiBlcnJvci5tZXNzYWdlID8gZXJyb3IubWVzc2FnZSA6IGVycm9yKTtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICB9XG5cblxuICAgICAgaWYgKHNuYWNrQmFyTXNnLmxlbmd0aCA+IDApIHtcbiAgICAgICAgdGhpcy5hdXRoUHJvY2Vzcy5zaG93VG9hc3Qoc25hY2tCYXJNc2cuam9pbignXFxcXG4nKSk7XG4gICAgICB9XG4gICAgICAvLyB0aGlzLnVwZGF0ZUZvcm1Hcm91cC5yZXNldCgpO1xuICAgIH1cblxuICAgIHRoaXMuZWRpdE1vZGUgPSBmYWxzZTtcbiAgfVxuXG4gIHNpZ25PdXQoKSB7XG4gICAgdGhpcy5hdXRoLmF1dGguc2lnbk91dCgpXG4gICAgICAudGhlbigoKSA9PiB0aGlzLm9uU2lnbk91dC5lbWl0KCkpXG4gICAgICAuY2F0Y2goZSA9PiBjb25zb2xlLmVycm9yKCdBbiBlcnJvciBoYXBwZW5lZCB3aGlsZSBzaWduaW5nIG91dCEnLCBlKSk7XG4gIH1cblxuICAvKipcbiAgICogRGVsZXRlIHRoZSBhY2NvdW50IG9mIHRoZSBjdXJyZW50IGZpcmViYXNlIG5neC1hdXRoLWZpcmViYXNldWktdXNlclxuICAgKlxuICAgKiBPbiBTdWNjZXNzLCBlbWl0IHRoZSA8b25BY2NvdW50RGVsZXRlZD4gZXZlbnQgYW5kIHRvYXN0IGEgbXNnISNcbiAgICogT3RoZXJ3aXNlLCBsb2cgdGhlIGFuZCB0b2FzdCBhbmQgZXJyb3IgbXNnIVxuICAgKlxuICAgKi9cbiAgYXN5bmMgZGVsZXRlQWNjb3VudCgpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlciA9IHRoaXMuYXV0aC5hdXRoLmN1cnJlbnRVc2VyO1xuXG4gICAgICAvLyBhd2FpdCB0aGlzLmF1dGhQcm9jZXNzLmRlbGV0ZUFjY291bnQoKTtcbiAgICAgIGF3YWl0IHRoaXMuYXV0aC5hdXRoLmN1cnJlbnRVc2VyLmRlbGV0ZSgpO1xuICAgICAgLy8gaWYgKHRoaXMuY29uZmlnLmVuYWJsZUZpcmVzdG9yZVN5bmMpIHtcbiAgICAgIGF3YWl0IHRoaXMuZmlyZVN0b3JlU2VydmljZS5kZWxldGVVc2VyRGF0YSh1c2VyLnVpZCk7XG4gICAgICAvLyB9XG4gICAgICB0aGlzLm9uQWNjb3VudERlbGV0ZWQuZW1pdCgpO1xuICAgICAgdGhpcy5lZGl0TW9kZSA9IGZhbHNlO1xuICAgICAgY29uc29sZS5sb2coJ1lvdXIgYWNjb3VudCBoYXMgYmVlbiBzdWNjZXNzZnVsbHkgZGVsZXRlZCEnKTtcbiAgICAgIHRoaXMuYXV0aFByb2Nlc3Muc2hvd1RvYXN0KCdZb3VyIGFjY291bnQgaGFzIGJlZW4gc3VjY2Vzc2Z1bGx5IGRlbGV0ZWQhJyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdFcnJvciB3aGlsZSBkZWxldGUgdXNlciBhY2NvdW50JywgZXJyb3IpO1xuICAgICAgdGhpcy5hdXRoUHJvY2Vzcy5zaG93VG9hc3QoYEVycm9yIG9jY3VycmVkIHdoaWxlIGRlbGV0aW5nIHlvdXIgYWNjb3VudDogJHtlcnJvci5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBpbml0VXBkYXRlRm9ybUdyb3VwKCkge1xuICAgIGNvbnN0IGN1cnJlbnRVc2VyOiBVc2VyID0gdGhpcy5hdXRoLmF1dGguY3VycmVudFVzZXI7XG4gICAgdGhpcy51cGRhdGVGb3JtR3JvdXAgPSBuZXcgRm9ybUdyb3VwKHtcbiAgICAgIG5hbWU6IHRoaXMudXBkYXRlTmFtZUZvcm1Db250cm9sID0gbmV3IEZvcm1Db250cm9sKFxuICAgICAgICB7dmFsdWU6IGN1cnJlbnRVc2VyLmRpc3BsYXlOYW1lLCBkaXNhYmxlZDogdGhpcy5lZGl0TW9kZX0sXG4gICAgICAgIFtcbiAgICAgICAgICBWYWxpZGF0b3JzLnJlcXVpcmVkLFxuICAgICAgICAgIFZhbGlkYXRvcnMubWluTGVuZ3RoKHRoaXMuY29uZmlnLm5hbWVNaW5MZW5ndGgpLFxuICAgICAgICAgIFZhbGlkYXRvcnMubWF4TGVuZ3RoKHRoaXMuY29uZmlnLm5hbWVNYXhMZW5ndGgpXG4gICAgICAgIF1cbiAgICAgICksXG5cbiAgICAgIGVtYWlsOiB0aGlzLnVwZGF0ZUVtYWlsRm9ybUNvbnRyb2wgPSBuZXcgRm9ybUNvbnRyb2woXG4gICAgICAgIHt2YWx1ZTogY3VycmVudFVzZXIuZW1haWwsIGRpc2FibGVkOiB0aGlzLmVkaXRNb2RlfSxcbiAgICAgICAgW1xuICAgICAgICAgIFZhbGlkYXRvcnMucmVxdWlyZWQsXG4gICAgICAgICAgVmFsaWRhdG9ycy5wYXR0ZXJuKEVNQUlMX1JFR0VYKVxuICAgICAgICBdKSxcblxuICAgICAgcGhvbmVOdW1iZXI6IHRoaXMudXBkYXRlUGhvbmVOdW1iZXJGb3JtQ29udHJvbCA9IG5ldyBGb3JtQ29udHJvbChcbiAgICAgICAge3ZhbHVlOiBjdXJyZW50VXNlci5waG9uZU51bWJlciwgZGlzYWJsZWQ6IHRoaXMuZWRpdE1vZGV9LFxuICAgICAgICBbVmFsaWRhdG9ycy5wYXR0ZXJuKFBIT05FX05VTUJFUl9SRUdFWCldKVxuICAgIH0pO1xuXG4gICAgdGhpcy51cGRhdGVGb3JtR3JvdXAuZW5hYmxlKCk7XG4gIH1cbn1cbiJdfQ==