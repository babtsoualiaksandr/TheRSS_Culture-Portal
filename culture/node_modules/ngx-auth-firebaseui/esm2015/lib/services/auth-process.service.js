import { __awaiter, __decorate, __param } from "tslib";
import { EventEmitter, forwardRef, Inject, Injectable } from '@angular/core';
import { AngularFireAuth } from '@angular/fire/auth';
import { firebase } from '@firebase/app';
import '@firebase/auth';
import { tap } from 'rxjs/operators';
import { Accounts } from '../enums';
import { FirestoreSyncService } from './firestore-sync.service';
import { MAT_SNACK_BAR_DEFAULT_OPTIONS, MatSnackBar, MatSnackBarConfig } from '@angular/material/snack-bar';
import { NgxAuthFirebaseUIConfigToken } from '../tokens';
import * as i0 from "@angular/core";
import * as i1 from "@angular/fire/auth";
import * as i2 from "../tokens/index";
import * as i3 from "@angular/material/snack-bar";
import * as i4 from "./firestore-sync.service";
export const facebookAuthProvider = new firebase.auth.FacebookAuthProvider();
export const googleAuthProvider = new firebase.auth.GoogleAuthProvider();
export const appleAuthProvider = new firebase.auth.OAuthProvider('apple.com');
export const twitterAuthProvider = new firebase.auth.TwitterAuthProvider();
export const githubAuthProvider = new firebase.auth.GithubAuthProvider();
export const microsoftAuthProvider = new firebase.auth.OAuthProvider('microsoft.com');
export const yahooAuthProvider = new firebase.auth.OAuthProvider('yahoo.com');
export var AuthProvider;
(function (AuthProvider) {
    AuthProvider["ALL"] = "all";
    AuthProvider["ANONYMOUS"] = "anonymous";
    AuthProvider["EmailAndPassword"] = "firebase";
    AuthProvider["Google"] = "google";
    AuthProvider["Apple"] = "Apple";
    AuthProvider["Facebook"] = "facebook";
    AuthProvider["Twitter"] = "twitter";
    AuthProvider["Github"] = "github";
    AuthProvider["Microsoft"] = "microsoft";
    AuthProvider["Yahoo"] = "yahoo";
    AuthProvider["PhoneNumber"] = "phoneNumber";
})(AuthProvider || (AuthProvider = {}));
let AuthProcessService = class AuthProcessService {
    constructor(afa, config, snackBar, fireStoreService, matSnackBarConfig) {
        this.afa = afa;
        this.config = config;
        this.snackBar = snackBar;
        this.fireStoreService = fireStoreService;
        this.matSnackBarConfig = matSnackBarConfig;
        this.onSuccessEmitter = new EventEmitter();
        this.onErrorEmitter = new EventEmitter();
    }
    listenToUserEvents() {
        this.user$ = this.afa.user.pipe(tap(user => {
            this.user = user;
        }));
    }
    /**
     * Reset the password of the ngx-auth-firebaseui-user via email
     *
     * @param email - the email to reset
     */
    resetPassword(email) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                console.log('Password reset email sent');
                return yield this.afa.auth.sendPasswordResetEmail(email);
            }
            catch (error) {
                return this.notifyError(error);
            }
        });
    }
    /**
     * General sign in mechanism to authenticate the users with a firebase project
     * using a traditional way, via username and password or by using an authentication provider
     * like google, facebook, twitter and github
     *
     * @param provider - the provider to authenticate with (google, facebook, twitter, github)
     * @param credentials
     */
    signInWith(provider, credentials) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                let signInResult;
                switch (provider) {
                    case AuthProvider.ANONYMOUS:
                        signInResult = (yield this.afa.auth.signInAnonymously());
                        break;
                    case AuthProvider.EmailAndPassword:
                        signInResult = (yield this.afa.auth.signInWithEmailAndPassword(credentials.email, credentials.password));
                        break;
                    case AuthProvider.Google:
                        signInResult = (yield this.afa.auth.signInWithPopup(googleAuthProvider));
                        break;
                    case AuthProvider.Apple:
                        signInResult = (yield this.afa.auth.signInWithPopup(appleAuthProvider));
                        break;
                    case AuthProvider.Facebook:
                        signInResult = (yield this.afa.auth.signInWithPopup(facebookAuthProvider));
                        break;
                    case AuthProvider.Twitter:
                        signInResult = (yield this.afa.auth.signInWithPopup(twitterAuthProvider));
                        break;
                    case AuthProvider.Github:
                        signInResult = (yield this.afa.auth.signInWithPopup(githubAuthProvider));
                        break;
                    case AuthProvider.Microsoft:
                        signInResult = (yield this.afa.auth.signInWithPopup(microsoftAuthProvider));
                        break;
                    case AuthProvider.Yahoo:
                        signInResult = (yield this.afa.auth.signInWithPopup(yahooAuthProvider));
                        break;
                    case AuthProvider.PhoneNumber:
                        // coming soon - see feature/sms branch
                        break;
                    default:
                        throw new Error(`${AuthProvider[provider]} is not available as auth provider`);
                }
                yield this.handleSuccess(signInResult);
            }
            catch (err) {
                this.handleError(err);
            }
        });
    }
    /**
     * Sign up new users via email and password.
     * After that the ngx-auth-firebaseui-user should verify and confirm an email sent via the firebase
     *
     * @param displayName - the displayName if the new ngx-auth-firebaseui-user
     * @returns -
     */
    signUp(displayName, credentials) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const userCredential = yield this.afa.auth.createUserWithEmailAndPassword(credentials.email, credentials.password);
                const user = userCredential.user;
                yield this.updateProfile(displayName, user.photoURL);
                if (this.config.enableFirestoreSync) {
                    yield this.fireStoreService
                        .getUserDocRefByUID(user.uid)
                        .set({
                        uid: user.uid,
                        displayName,
                        email: user.email,
                        photoURL: user.photoURL
                    });
                }
                if (this.config.enableEmailVerification) {
                    yield user.sendEmailVerification();
                }
                // Legacy fields
                this.emailConfirmationSent = true;
                this.emailToConfirm = credentials.email;
                yield this.handleSuccess(userCredential);
            }
            catch (err) {
                this.handleError(err);
            }
        });
    }
    sendNewVerificationEmail() {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.user) {
                return Promise.reject(new Error('No signed in user'));
            }
            return this.user.sendEmailVerification();
        });
    }
    signOut() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                yield this.afa.auth.signOut();
            }
            catch (error) {
                this.notifyError(error);
            }
        });
    }
    /**
     * Update the profile (name + photo url) of the authenticated ngx-auth-firebaseui-user in the
     * firebase authentication feature (not in firestore)
     *
     * @param name - the new name of the authenticated ngx-auth-firebaseui-user
     * @param photoURL - the new photo url of the authenticated ngx-auth-firebaseui-user
     * @returns -
     */
    updateProfile(name, photoURL) {
        if (!photoURL) {
            return this.afa.auth.currentUser.updateProfile({ displayName: name });
        }
        else {
            return this.afa.auth.currentUser.updateProfile({ displayName: name, photoURL });
        }
    }
    deleteAccount() {
        return this.afa.auth.currentUser.delete();
    }
    parseUserInfo(user) {
        return {
            uid: user.uid,
            displayName: user.displayName,
            email: user.email,
            phoneNumber: user.phoneNumber,
            photoURL: user.photoURL,
            providerId: user.providerData.length > 0 ? user.providerData[0].providerId : null
        };
    }
    getUserPhotoUrl() {
        const user = this.afa.auth.currentUser;
        if (!user) {
            return;
        }
        else if (user.photoURL) {
            return user.photoURL;
        }
        else if (user.emailVerified) {
            return this.getPhotoPath(Accounts.CHECK);
        }
        else if (user.isAnonymous) {
            return this.getPhotoPath(Accounts.OFF);
        }
        else {
            return this.getPhotoPath(Accounts.NONE);
        }
    }
    getPhotoPath(image) {
        return `assets/user/${image}.svg`;
    }
    signInWithPhoneNumber() {
        // todo: 3.1.18
    }
    handleSuccess(userCredential) {
        return __awaiter(this, void 0, void 0, function* () {
            this.onSuccessEmitter.next(userCredential.user);
            if (this.config.enableFirestoreSync) {
                try {
                    yield this.fireStoreService.updateUserData(this.parseUserInfo(userCredential.user));
                }
                catch (e) {
                    console.error(`Error occurred while updating user data with firestore: ${e}`);
                }
            }
            if (this.config.toastMessageOnAuthSuccess) {
                const fallbackMessage = `Hello ${userCredential.user.displayName ? userCredential.user.displayName : ''}!`;
                this.showToast(this.messageOnAuthSuccess || fallbackMessage);
            }
        });
    }
    handleError(error) {
        this.notifyError(error);
        console.error(error);
    }
    // Refresh user info. Can be useful for instance to get latest status regarding email verification.
    reloadUserInfo() {
        return this.user.reload();
    }
    // Search for an error message.
    // Consumers of this library are given the possibility to provide a
    // function in case they want to instrument message based on error properties.
    getMessageOnAuthError(error) {
        // tslint:disable-next-line:no-bitwise
        return error.toString() || 'Sorry, something went wrong. Please retry later.';
    }
    // Show a toast using current snackbar config. If message is empty, no toast is displayed allowing to opt-out when needed.
    // Default MatSnackBarConfig has no duration, meaning it stays visible forever.
    // If that's the case, an action button is added to allow the end-user to dismiss the toast.
    showToast(message) {
        if (message) {
            this.snackBar.open(message, this.matSnackBarConfig.duration ? null : 'OK');
        }
    }
    showErrorToast(error) {
        if (this.config.toastMessageOnAuthError) {
            this.showToast(this.getMessageOnAuthError(error));
        }
    }
    notifyError(error) {
        this.onErrorEmitter.emit(error);
        this.showErrorToast(error);
    }
};
AuthProcessService.ctorParameters = () => [
    { type: AngularFireAuth },
    { type: undefined, decorators: [{ type: Inject, args: [forwardRef(() => NgxAuthFirebaseUIConfigToken),] }] },
    { type: MatSnackBar },
    { type: FirestoreSyncService },
    { type: MatSnackBarConfig, decorators: [{ type: Inject, args: [MAT_SNACK_BAR_DEFAULT_OPTIONS,] }] }
];
AuthProcessService.ɵprov = i0.ɵɵdefineInjectable({ factory: function AuthProcessService_Factory() { return new AuthProcessService(i0.ɵɵinject(i1.AngularFireAuth), i0.ɵɵinject(i2.NgxAuthFirebaseUIConfigToken), i0.ɵɵinject(i3.MatSnackBar), i0.ɵɵinject(i4.FirestoreSyncService), i0.ɵɵinject(i3.MAT_SNACK_BAR_DEFAULT_OPTIONS)); }, token: AuthProcessService, providedIn: "root" });
AuthProcessService = __decorate([
    Injectable({
        providedIn: 'root'
    }),
    __param(1, Inject(forwardRef(() => NgxAuthFirebaseUIConfigToken))),
    __param(4, Inject(MAT_SNACK_BAR_DEFAULT_OPTIONS))
], AuthProcessService);
export { AuthProcessService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC1wcm9jZXNzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtYXV0aC1maXJlYmFzZXVpLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL2F1dGgtcHJvY2Vzcy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUMsWUFBWSxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQzNFLE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSxvQkFBb0IsQ0FBQztBQUNuRCxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3ZDLE9BQU8sZ0JBQWdCLENBQUM7QUFHeEIsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ25DLE9BQU8sRUFBQyxRQUFRLEVBQUMsTUFBTSxVQUFVLENBQUM7QUFDbEMsT0FBTyxFQUFDLG9CQUFvQixFQUFDLE1BQU0sMEJBQTBCLENBQUM7QUFDOUQsT0FBTyxFQUFDLDZCQUE2QixFQUFFLFdBQVcsRUFBRSxpQkFBaUIsRUFBQyxNQUFNLDZCQUE2QixDQUFDO0FBRTFHLE9BQU8sRUFBQyw0QkFBNEIsRUFBQyxNQUFNLFdBQVcsQ0FBQzs7Ozs7O0FBTXZELE1BQU0sQ0FBQyxNQUFNLG9CQUFvQixHQUFHLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO0FBQzdFLE1BQU0sQ0FBQyxNQUFNLGtCQUFrQixHQUFHLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO0FBQ3pFLE1BQU0sQ0FBQyxNQUFNLGlCQUFpQixHQUFHLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDOUUsTUFBTSxDQUFDLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7QUFDM0UsTUFBTSxDQUFDLE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7QUFDekUsTUFBTSxDQUFDLE1BQU0scUJBQXFCLEdBQUcsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUN0RixNQUFNLENBQUMsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBRTlFLE1BQU0sQ0FBTixJQUFZLFlBWVg7QUFaRCxXQUFZLFlBQVk7SUFDdEIsMkJBQVcsQ0FBQTtJQUNYLHVDQUF1QixDQUFBO0lBQ3ZCLDZDQUE2QixDQUFBO0lBQzdCLGlDQUFpQixDQUFBO0lBQ2pCLCtCQUFlLENBQUE7SUFDZixxQ0FBcUIsQ0FBQTtJQUNyQixtQ0FBbUIsQ0FBQTtJQUNuQixpQ0FBaUIsQ0FBQTtJQUNqQix1Q0FBdUIsQ0FBQTtJQUN2QiwrQkFBZSxDQUFBO0lBQ2YsMkNBQTJCLENBQUE7QUFDN0IsQ0FBQyxFQVpXLFlBQVksS0FBWixZQUFZLFFBWXZCO0FBS0QsSUFBYSxrQkFBa0IsR0FBL0IsTUFBYSxrQkFBa0I7SUFrQjdCLFlBQ1MsR0FBb0IsRUFDb0MsTUFBK0IsRUFDdEYsUUFBcUIsRUFDckIsZ0JBQXNDLEVBQ0MsaUJBQW9DO1FBSjVFLFFBQUcsR0FBSCxHQUFHLENBQWlCO1FBQ29DLFdBQU0sR0FBTixNQUFNLENBQXlCO1FBQ3RGLGFBQVEsR0FBUixRQUFRLENBQWE7UUFDckIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFzQjtRQUNDLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUF0QnJGLHFCQUFnQixHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO1FBQzlELG1CQUFjLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7SUF1QjVELENBQUM7SUFFRCxrQkFBa0I7UUFDaEIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQzdCLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUNULElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ25CLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNVLGFBQWEsQ0FBQyxLQUFhOztZQUN0QyxJQUFJO2dCQUNGLE9BQU8sQ0FBQyxHQUFHLENBQUMsMkJBQTJCLENBQUMsQ0FBQztnQkFDekMsT0FBTyxNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQzFEO1lBQUMsT0FBTyxLQUFLLEVBQUU7Z0JBQ2QsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ2hDO1FBQ0gsQ0FBQztLQUFBO0lBRUQ7Ozs7Ozs7T0FPRztJQUNVLFVBQVUsQ0FBQyxRQUFzQixFQUFFLFdBQTBCOztZQUN4RSxJQUFJO2dCQUNGLElBQUksWUFBa0MsQ0FBQztnQkFFdkMsUUFBUSxRQUFRLEVBQUU7b0JBQ2hCLEtBQUssWUFBWSxDQUFDLFNBQVM7d0JBQ3pCLFlBQVksSUFBRyxNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFvQixDQUFBLENBQUM7d0JBQ3pFLE1BQU07b0JBRVIsS0FBSyxZQUFZLENBQUMsZ0JBQWdCO3dCQUNoQyxZQUFZLElBQUcsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLFdBQVcsQ0FBQyxRQUFRLENBQW1CLENBQUEsQ0FBQzt3QkFDekgsTUFBTTtvQkFFUixLQUFLLFlBQVksQ0FBQyxNQUFNO3dCQUN0QixZQUFZLElBQUcsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsa0JBQWtCLENBQW1CLENBQUEsQ0FBQzt3QkFDekYsTUFBTTtvQkFFUixLQUFLLFlBQVksQ0FBQyxLQUFLO3dCQUNyQixZQUFZLElBQUcsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsaUJBQWlCLENBQW1CLENBQUEsQ0FBQzt3QkFDeEYsTUFBTTtvQkFFUixLQUFLLFlBQVksQ0FBQyxRQUFRO3dCQUN4QixZQUFZLElBQUcsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsb0JBQW9CLENBQW1CLENBQUEsQ0FBQzt3QkFDM0YsTUFBTTtvQkFFUixLQUFLLFlBQVksQ0FBQyxPQUFPO3dCQUN2QixZQUFZLElBQUcsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsbUJBQW1CLENBQW1CLENBQUEsQ0FBQzt3QkFDMUYsTUFBTTtvQkFFUixLQUFLLFlBQVksQ0FBQyxNQUFNO3dCQUN0QixZQUFZLElBQUcsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsa0JBQWtCLENBQW1CLENBQUEsQ0FBQzt3QkFDekYsTUFBTTtvQkFFUixLQUFLLFlBQVksQ0FBQyxTQUFTO3dCQUN6QixZQUFZLElBQUcsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMscUJBQXFCLENBQW1CLENBQUEsQ0FBQzt3QkFDNUYsTUFBTTtvQkFFUixLQUFLLFlBQVksQ0FBQyxLQUFLO3dCQUNyQixZQUFZLElBQUcsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsaUJBQWlCLENBQW1CLENBQUEsQ0FBQzt3QkFDeEYsTUFBTTtvQkFFUixLQUFLLFlBQVksQ0FBQyxXQUFXO3dCQUMzQix1Q0FBdUM7d0JBQ3ZDLE1BQU07b0JBRVI7d0JBQ0UsTUFBTSxJQUFJLEtBQUssQ0FBQyxHQUFHLFlBQVksQ0FBQyxRQUFRLENBQUMsb0NBQW9DLENBQUMsQ0FBQztpQkFDbEY7Z0JBQ0QsTUFBTSxJQUFJLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO2FBQ3hDO1lBQUMsT0FBTyxHQUFHLEVBQUU7Z0JBQ1osSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUN2QjtRQUNILENBQUM7S0FBQTtJQUVEOzs7Ozs7T0FNRztJQUNVLE1BQU0sQ0FBQyxXQUFtQixFQUFFLFdBQXlCOztZQUNoRSxJQUFJO2dCQUNGLE1BQU0sY0FBYyxHQUFtQixNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLDhCQUE4QixDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUNuSSxNQUFNLElBQUksR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDO2dCQUNqQyxNQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFFckQsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLG1CQUFtQixFQUFFO29CQUNuQyxNQUFNLElBQUksQ0FBQyxnQkFBZ0I7eUJBQ3hCLGtCQUFrQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7eUJBQzVCLEdBQUcsQ0FBQzt3QkFDSCxHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUc7d0JBQ2IsV0FBVzt3QkFDWCxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUs7d0JBQ2pCLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtxQkFDaEIsQ0FBQyxDQUFDO2lCQUNkO2dCQUVELElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyx1QkFBdUIsRUFBRTtvQkFDdkMsTUFBTSxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztpQkFDcEM7Z0JBRUQsZ0JBQWdCO2dCQUNoQixJQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSxDQUFDO2dCQUNsQyxJQUFJLENBQUMsY0FBYyxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUM7Z0JBRXhDLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQUMsQ0FBQzthQUMxQztZQUFDLE9BQU8sR0FBRyxFQUFFO2dCQUNaLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDdkI7UUFDSCxDQUFDO0tBQUE7SUFFSyx3QkFBd0I7O1lBQzVCLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFO2dCQUNkLE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUM7YUFDdkQ7WUFDRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUMzQyxDQUFDO0tBQUE7SUFFSyxPQUFPOztZQUNYLElBQUk7Z0JBQ0YsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQzthQUMvQjtZQUFDLE9BQU8sS0FBSyxFQUFFO2dCQUNkLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDekI7UUFDSCxDQUFDO0tBQUE7SUFFRDs7Ozs7OztPQU9HO0lBQ0ksYUFBYSxDQUFDLElBQVksRUFBRSxRQUFnQjtRQUNqRCxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2IsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLEVBQUMsV0FBVyxFQUFFLElBQUksRUFBQyxDQUFDLENBQUM7U0FDckU7YUFBTTtZQUNMLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxFQUFDLFdBQVcsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFDLENBQUMsQ0FBQztTQUMvRTtJQUNILENBQUM7SUFFTSxhQUFhO1FBQ2xCLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQzVDLENBQUM7SUFFTSxhQUFhLENBQUMsSUFBVTtRQUM3QixPQUFPO1lBQ0wsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHO1lBQ2IsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXO1lBQzdCLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSztZQUNqQixXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVc7WUFDN0IsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO1lBQ3ZCLFVBQVUsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJO1NBQ2xGLENBQUM7SUFDSixDQUFDO0lBRU0sZUFBZTtRQUVwQixNQUFNLElBQUksR0FBeUIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDO1FBRTdELElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDVCxPQUFPO1NBQ1I7YUFBTSxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDeEIsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDO1NBQ3RCO2FBQU0sSUFBSSxJQUFJLENBQUMsYUFBYSxFQUFFO1lBQzdCLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDMUM7YUFBTSxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDM0IsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUN4QzthQUFNO1lBQ0wsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN6QztJQUNILENBQUM7SUFFTSxZQUFZLENBQUMsS0FBYTtRQUMvQixPQUFPLGVBQWUsS0FBSyxNQUFNLENBQUM7SUFDcEMsQ0FBQztJQUVNLHFCQUFxQjtRQUMxQixlQUFlO0lBQ2pCLENBQUM7SUFFSyxhQUFhLENBQUMsY0FBOEI7O1lBQ2hELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2hELElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxtQkFBbUIsRUFBRTtnQkFDbkMsSUFBSTtvQkFDRixNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztpQkFDckY7Z0JBQUMsT0FBTyxDQUFDLEVBQUU7b0JBQ1YsT0FBTyxDQUFDLEtBQUssQ0FBQywyREFBMkQsQ0FBQyxFQUFFLENBQUMsQ0FBQztpQkFDL0U7YUFDRjtZQUNELElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyx5QkFBeUIsRUFBRTtnQkFDekMsTUFBTSxlQUFlLEdBQUcsU0FBUyxjQUFjLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDO2dCQUMzRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsSUFBSSxlQUFlLENBQUMsQ0FBQzthQUM5RDtRQUNILENBQUM7S0FBQTtJQUVELFdBQVcsQ0FBQyxLQUFVO1FBQ3BCLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDeEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN2QixDQUFDO0lBRUQsbUdBQW1HO0lBQ25HLGNBQWM7UUFDWixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVELCtCQUErQjtJQUMvQixtRUFBbUU7SUFDbkUsOEVBQThFO0lBQzlFLHFCQUFxQixDQUFDLEtBQVU7UUFDOUIsc0NBQXNDO1FBQ3RDLE9BQU8sS0FBSyxDQUFDLFFBQVEsRUFBRSxJQUFJLGtEQUFrRCxDQUFDO0lBQ2hGLENBQUM7SUFFRCwwSEFBMEg7SUFDMUgsK0VBQStFO0lBQy9FLDRGQUE0RjtJQUM1RixTQUFTLENBQUMsT0FBZTtRQUN2QixJQUFJLE9BQU8sRUFBRTtZQUNYLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzVFO0lBQ0gsQ0FBQztJQUVELGNBQWMsQ0FBQyxLQUFVO1FBQ3ZCLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyx1QkFBdUIsRUFBRTtZQUN2QyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1NBQ25EO0lBQ0gsQ0FBQztJQUVELFdBQVcsQ0FBQyxLQUFVO1FBQ3BCLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2hDLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDN0IsQ0FBQztDQUVGLENBQUE7O1lBOVBlLGVBQWU7NENBQzFCLE1BQU0sU0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsNEJBQTRCLENBQUM7WUFDcEMsV0FBVztZQUNILG9CQUFvQjtZQUNvQixpQkFBaUIsdUJBQWxGLE1BQU0sU0FBQyw2QkFBNkI7OztBQXZCNUIsa0JBQWtCO0lBSDlCLFVBQVUsQ0FBQztRQUNWLFVBQVUsRUFBRSxNQUFNO0tBQ25CLENBQUM7SUFxQkcsV0FBQSxNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLDRCQUE0QixDQUFDLENBQUMsQ0FBQTtJQUd0RCxXQUFBLE1BQU0sQ0FBQyw2QkFBNkIsQ0FBQyxDQUFBO0dBdkI3QixrQkFBa0IsQ0FpUjlCO1NBalJZLGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RXZlbnRFbWl0dGVyLCBmb3J3YXJkUmVmLCBJbmplY3QsIEluamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtBbmd1bGFyRmlyZUF1dGh9IGZyb20gJ0Bhbmd1bGFyL2ZpcmUvYXV0aCc7XG5pbXBvcnQge2ZpcmViYXNlfSBmcm9tICdAZmlyZWJhc2UvYXBwJztcbmltcG9ydCAnQGZpcmViYXNlL2F1dGgnO1xuaW1wb3J0IHtVc2VyLCBVc2VySW5mb30gZnJvbSAnZmlyZWJhc2UvYXBwJztcbmltcG9ydCB7T2JzZXJ2YWJsZX0gZnJvbSAncnhqcyc7XG5pbXBvcnQge3RhcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtBY2NvdW50c30gZnJvbSAnLi4vZW51bXMnO1xuaW1wb3J0IHtGaXJlc3RvcmVTeW5jU2VydmljZX0gZnJvbSAnLi9maXJlc3RvcmUtc3luYy5zZXJ2aWNlJztcbmltcG9ydCB7TUFUX1NOQUNLX0JBUl9ERUZBVUxUX09QVElPTlMsIE1hdFNuYWNrQmFyLCBNYXRTbmFja0JhckNvbmZpZ30gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvc25hY2stYmFyJztcbmltcG9ydCB7SUNyZWRlbnRpYWxzLCBJU2lnbkluUHJvY2VzcywgSVNpZ25VcFByb2Nlc3MsIE5neEF1dGhGaXJlYmFzZVVJQ29uZmlnfSBmcm9tICcuLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7Tmd4QXV0aEZpcmViYXNlVUlDb25maWdUb2tlbn0gZnJvbSAnLi4vdG9rZW5zJztcblxuLy8gaW1wb3J0IFVzZXIgPSBmaXJlYmFzZS5Vc2VyO1xuXG5pbXBvcnQgVXNlckNyZWRlbnRpYWwgPSBmaXJlYmFzZS5hdXRoLlVzZXJDcmVkZW50aWFsO1xuXG5leHBvcnQgY29uc3QgZmFjZWJvb2tBdXRoUHJvdmlkZXIgPSBuZXcgZmlyZWJhc2UuYXV0aC5GYWNlYm9va0F1dGhQcm92aWRlcigpO1xuZXhwb3J0IGNvbnN0IGdvb2dsZUF1dGhQcm92aWRlciA9IG5ldyBmaXJlYmFzZS5hdXRoLkdvb2dsZUF1dGhQcm92aWRlcigpO1xuZXhwb3J0IGNvbnN0IGFwcGxlQXV0aFByb3ZpZGVyID0gbmV3IGZpcmViYXNlLmF1dGguT0F1dGhQcm92aWRlcignYXBwbGUuY29tJyk7XG5leHBvcnQgY29uc3QgdHdpdHRlckF1dGhQcm92aWRlciA9IG5ldyBmaXJlYmFzZS5hdXRoLlR3aXR0ZXJBdXRoUHJvdmlkZXIoKTtcbmV4cG9ydCBjb25zdCBnaXRodWJBdXRoUHJvdmlkZXIgPSBuZXcgZmlyZWJhc2UuYXV0aC5HaXRodWJBdXRoUHJvdmlkZXIoKTtcbmV4cG9ydCBjb25zdCBtaWNyb3NvZnRBdXRoUHJvdmlkZXIgPSBuZXcgZmlyZWJhc2UuYXV0aC5PQXV0aFByb3ZpZGVyKCdtaWNyb3NvZnQuY29tJyk7XG5leHBvcnQgY29uc3QgeWFob29BdXRoUHJvdmlkZXIgPSBuZXcgZmlyZWJhc2UuYXV0aC5PQXV0aFByb3ZpZGVyKCd5YWhvby5jb20nKTtcblxuZXhwb3J0IGVudW0gQXV0aFByb3ZpZGVyIHtcbiAgQUxMID0gJ2FsbCcsXG4gIEFOT05ZTU9VUyA9ICdhbm9ueW1vdXMnLFxuICBFbWFpbEFuZFBhc3N3b3JkID0gJ2ZpcmViYXNlJyxcbiAgR29vZ2xlID0gJ2dvb2dsZScsXG4gIEFwcGxlID0gJ0FwcGxlJyxcbiAgRmFjZWJvb2sgPSAnZmFjZWJvb2snLFxuICBUd2l0dGVyID0gJ3R3aXR0ZXInLFxuICBHaXRodWIgPSAnZ2l0aHViJyxcbiAgTWljcm9zb2Z0ID0gJ21pY3Jvc29mdCcsXG4gIFlhaG9vID0gJ3lhaG9vJyxcbiAgUGhvbmVOdW1iZXIgPSAncGhvbmVOdW1iZXInXG59XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEF1dGhQcm9jZXNzU2VydmljZSBpbXBsZW1lbnRzIElTaWduSW5Qcm9jZXNzLCBJU2lnblVwUHJvY2VzcyB7XG4gIG9uU3VjY2Vzc0VtaXR0ZXI6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIG9uRXJyb3JFbWl0dGVyOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIC8vIFVzZWZ1bCB0byBrbm93IGF1Ym91dCBhdXRoIHN0YXRlIGV2ZW4gYmV0d2VlbiByZWxvYWRzLlxuICAvLyBSZXBsYWNlIGVtYWlsQ29uZmlybWF0aW9uU2VudCBhbmQgZW1haWxUb0NvbmZpcm0uXG4gIHVzZXIkOiBPYnNlcnZhYmxlPFVzZXI+O1xuICB1c2VyOiBVc2VyO1xuXG4gIG1lc3NhZ2VPbkF1dGhTdWNjZXNzOiBzdHJpbmc7XG4gIG1lc3NhZ2VPbkF1dGhFcnJvcjogc3RyaW5nO1xuXG4gIC8vIExlZ2FjeSBmaWVsZCB0aGF0IGlzIHNldHRlZCB0byB0cnVlIGFmdGVyIHNpZ24gdXAuXG4gIC8vIFZhbHVlIGlzIGxvc3QgaW4gY2FzZSBvZiByZWxvYWQuIFRoZSBpZGVhIGhlcmUgaXMgdG8ga25vdyBpZiB3ZSBqdXN0IHNlbnQgYSB2ZXJpZmljYXRpb24gZW1haWwuXG4gIGVtYWlsQ29uZmlybWF0aW9uU2VudDogYm9vbGVhbjtcbiAgLy8gTGVmYWN5IGZpbGVkIHRoYXQgY29udGFpbiB0aGUgbWFpbCB0byBjb25maXJtLiBTYW1lIGxpZmVjeWxlIHRoYW4gZW1haWxDb25maXJtYXRpb25TZW50LlxuICBlbWFpbFRvQ29uZmlybTogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBhZmE6IEFuZ3VsYXJGaXJlQXV0aCxcbiAgICBASW5qZWN0KGZvcndhcmRSZWYoKCkgPT4gTmd4QXV0aEZpcmViYXNlVUlDb25maWdUb2tlbikpIHB1YmxpYyBjb25maWc6IE5neEF1dGhGaXJlYmFzZVVJQ29uZmlnLFxuICAgIHByaXZhdGUgc25hY2tCYXI6IE1hdFNuYWNrQmFyLFxuICAgIHByaXZhdGUgZmlyZVN0b3JlU2VydmljZTogRmlyZXN0b3JlU3luY1NlcnZpY2UsXG4gICAgQEluamVjdChNQVRfU05BQ0tfQkFSX0RFRkFVTFRfT1BUSU9OUykgcHJpdmF0ZSBtYXRTbmFja0JhckNvbmZpZzogTWF0U25hY2tCYXJDb25maWdcbiAgKSB7XG4gIH1cblxuICBsaXN0ZW5Ub1VzZXJFdmVudHMoKSB7XG4gICAgdGhpcy51c2VyJCA9IHRoaXMuYWZhLnVzZXIucGlwZShcbiAgICAgIHRhcCh1c2VyID0+IHtcbiAgICAgICAgdGhpcy51c2VyID0gdXNlcjtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNldCB0aGUgcGFzc3dvcmQgb2YgdGhlIG5neC1hdXRoLWZpcmViYXNldWktdXNlciB2aWEgZW1haWxcbiAgICpcbiAgICogQHBhcmFtIGVtYWlsIC0gdGhlIGVtYWlsIHRvIHJlc2V0XG4gICAqL1xuICBwdWJsaWMgYXN5bmMgcmVzZXRQYXNzd29yZChlbWFpbDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnNvbGUubG9nKCdQYXNzd29yZCByZXNldCBlbWFpbCBzZW50Jyk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5hZmEuYXV0aC5zZW5kUGFzc3dvcmRSZXNldEVtYWlsKGVtYWlsKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIHRoaXMubm90aWZ5RXJyb3IoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmFsIHNpZ24gaW4gbWVjaGFuaXNtIHRvIGF1dGhlbnRpY2F0ZSB0aGUgdXNlcnMgd2l0aCBhIGZpcmViYXNlIHByb2plY3RcbiAgICogdXNpbmcgYSB0cmFkaXRpb25hbCB3YXksIHZpYSB1c2VybmFtZSBhbmQgcGFzc3dvcmQgb3IgYnkgdXNpbmcgYW4gYXV0aGVudGljYXRpb24gcHJvdmlkZXJcbiAgICogbGlrZSBnb29nbGUsIGZhY2Vib29rLCB0d2l0dGVyIGFuZCBnaXRodWJcbiAgICpcbiAgICogQHBhcmFtIHByb3ZpZGVyIC0gdGhlIHByb3ZpZGVyIHRvIGF1dGhlbnRpY2F0ZSB3aXRoIChnb29nbGUsIGZhY2Vib29rLCB0d2l0dGVyLCBnaXRodWIpXG4gICAqIEBwYXJhbSBjcmVkZW50aWFsc1xuICAgKi9cbiAgcHVibGljIGFzeW5jIHNpZ25JbldpdGgocHJvdmlkZXI6IEF1dGhQcm92aWRlciwgY3JlZGVudGlhbHM/OiBJQ3JlZGVudGlhbHMpIHtcbiAgICB0cnkge1xuICAgICAgbGV0IHNpZ25JblJlc3VsdDogVXNlckNyZWRlbnRpYWwgfCBhbnk7XG5cbiAgICAgIHN3aXRjaCAocHJvdmlkZXIpIHtcbiAgICAgICAgY2FzZSBBdXRoUHJvdmlkZXIuQU5PTllNT1VTOlxuICAgICAgICAgIHNpZ25JblJlc3VsdCA9IGF3YWl0IHRoaXMuYWZhLmF1dGguc2lnbkluQW5vbnltb3VzbHkoKSBhcyBVc2VyQ3JlZGVudGlhbDtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIEF1dGhQcm92aWRlci5FbWFpbEFuZFBhc3N3b3JkOlxuICAgICAgICAgIHNpZ25JblJlc3VsdCA9IGF3YWl0IHRoaXMuYWZhLmF1dGguc2lnbkluV2l0aEVtYWlsQW5kUGFzc3dvcmQoY3JlZGVudGlhbHMuZW1haWwsIGNyZWRlbnRpYWxzLnBhc3N3b3JkKSBhcyBVc2VyQ3JlZGVudGlhbDtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIEF1dGhQcm92aWRlci5Hb29nbGU6XG4gICAgICAgICAgc2lnbkluUmVzdWx0ID0gYXdhaXQgdGhpcy5hZmEuYXV0aC5zaWduSW5XaXRoUG9wdXAoZ29vZ2xlQXV0aFByb3ZpZGVyKSBhcyBVc2VyQ3JlZGVudGlhbDtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIEF1dGhQcm92aWRlci5BcHBsZTpcbiAgICAgICAgICBzaWduSW5SZXN1bHQgPSBhd2FpdCB0aGlzLmFmYS5hdXRoLnNpZ25JbldpdGhQb3B1cChhcHBsZUF1dGhQcm92aWRlcikgYXMgVXNlckNyZWRlbnRpYWw7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBBdXRoUHJvdmlkZXIuRmFjZWJvb2s6XG4gICAgICAgICAgc2lnbkluUmVzdWx0ID0gYXdhaXQgdGhpcy5hZmEuYXV0aC5zaWduSW5XaXRoUG9wdXAoZmFjZWJvb2tBdXRoUHJvdmlkZXIpIGFzIFVzZXJDcmVkZW50aWFsO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgQXV0aFByb3ZpZGVyLlR3aXR0ZXI6XG4gICAgICAgICAgc2lnbkluUmVzdWx0ID0gYXdhaXQgdGhpcy5hZmEuYXV0aC5zaWduSW5XaXRoUG9wdXAodHdpdHRlckF1dGhQcm92aWRlcikgYXMgVXNlckNyZWRlbnRpYWw7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBBdXRoUHJvdmlkZXIuR2l0aHViOlxuICAgICAgICAgIHNpZ25JblJlc3VsdCA9IGF3YWl0IHRoaXMuYWZhLmF1dGguc2lnbkluV2l0aFBvcHVwKGdpdGh1YkF1dGhQcm92aWRlcikgYXMgVXNlckNyZWRlbnRpYWw7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBBdXRoUHJvdmlkZXIuTWljcm9zb2Z0OlxuICAgICAgICAgIHNpZ25JblJlc3VsdCA9IGF3YWl0IHRoaXMuYWZhLmF1dGguc2lnbkluV2l0aFBvcHVwKG1pY3Jvc29mdEF1dGhQcm92aWRlcikgYXMgVXNlckNyZWRlbnRpYWw7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBBdXRoUHJvdmlkZXIuWWFob286XG4gICAgICAgICAgc2lnbkluUmVzdWx0ID0gYXdhaXQgdGhpcy5hZmEuYXV0aC5zaWduSW5XaXRoUG9wdXAoeWFob29BdXRoUHJvdmlkZXIpIGFzIFVzZXJDcmVkZW50aWFsO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgQXV0aFByb3ZpZGVyLlBob25lTnVtYmVyOlxuICAgICAgICAgIC8vIGNvbWluZyBzb29uIC0gc2VlIGZlYXR1cmUvc21zIGJyYW5jaFxuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke0F1dGhQcm92aWRlcltwcm92aWRlcl19IGlzIG5vdCBhdmFpbGFibGUgYXMgYXV0aCBwcm92aWRlcmApO1xuICAgICAgfVxuICAgICAgYXdhaXQgdGhpcy5oYW5kbGVTdWNjZXNzKHNpZ25JblJlc3VsdCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aGlzLmhhbmRsZUVycm9yKGVycik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNpZ24gdXAgbmV3IHVzZXJzIHZpYSBlbWFpbCBhbmQgcGFzc3dvcmQuXG4gICAqIEFmdGVyIHRoYXQgdGhlIG5neC1hdXRoLWZpcmViYXNldWktdXNlciBzaG91bGQgdmVyaWZ5IGFuZCBjb25maXJtIGFuIGVtYWlsIHNlbnQgdmlhIHRoZSBmaXJlYmFzZVxuICAgKlxuICAgKiBAcGFyYW0gZGlzcGxheU5hbWUgLSB0aGUgZGlzcGxheU5hbWUgaWYgdGhlIG5ldyBuZ3gtYXV0aC1maXJlYmFzZXVpLXVzZXJcbiAgICogQHJldHVybnMgLVxuICAgKi9cbiAgcHVibGljIGFzeW5jIHNpZ25VcChkaXNwbGF5TmFtZTogc3RyaW5nLCBjcmVkZW50aWFsczogSUNyZWRlbnRpYWxzKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVzZXJDcmVkZW50aWFsOiBVc2VyQ3JlZGVudGlhbCA9IGF3YWl0IHRoaXMuYWZhLmF1dGguY3JlYXRlVXNlcldpdGhFbWFpbEFuZFBhc3N3b3JkKGNyZWRlbnRpYWxzLmVtYWlsLCBjcmVkZW50aWFscy5wYXNzd29yZCk7XG4gICAgICBjb25zdCB1c2VyID0gdXNlckNyZWRlbnRpYWwudXNlcjtcbiAgICAgIGF3YWl0IHRoaXMudXBkYXRlUHJvZmlsZShkaXNwbGF5TmFtZSwgdXNlci5waG90b1VSTCk7XG5cbiAgICAgIGlmICh0aGlzLmNvbmZpZy5lbmFibGVGaXJlc3RvcmVTeW5jKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuZmlyZVN0b3JlU2VydmljZVxuICAgICAgICAgIC5nZXRVc2VyRG9jUmVmQnlVSUQodXNlci51aWQpXG4gICAgICAgICAgLnNldCh7XG4gICAgICAgICAgICB1aWQ6IHVzZXIudWlkLFxuICAgICAgICAgICAgZGlzcGxheU5hbWUsXG4gICAgICAgICAgICBlbWFpbDogdXNlci5lbWFpbCxcbiAgICAgICAgICAgIHBob3RvVVJMOiB1c2VyLnBob3RvVVJMXG4gICAgICAgICAgfSBhcyBVc2VyKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMuY29uZmlnLmVuYWJsZUVtYWlsVmVyaWZpY2F0aW9uKSB7XG4gICAgICAgIGF3YWl0IHVzZXIuc2VuZEVtYWlsVmVyaWZpY2F0aW9uKCk7XG4gICAgICB9XG5cbiAgICAgIC8vIExlZ2FjeSBmaWVsZHNcbiAgICAgIHRoaXMuZW1haWxDb25maXJtYXRpb25TZW50ID0gdHJ1ZTtcbiAgICAgIHRoaXMuZW1haWxUb0NvbmZpcm0gPSBjcmVkZW50aWFscy5lbWFpbDtcblxuICAgICAgYXdhaXQgdGhpcy5oYW5kbGVTdWNjZXNzKHVzZXJDcmVkZW50aWFsKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRoaXMuaGFuZGxlRXJyb3IoZXJyKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzZW5kTmV3VmVyaWZpY2F0aW9uRW1haWwoKSB7XG4gICAgaWYgKCF0aGlzLnVzZXIpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ05vIHNpZ25lZCBpbiB1c2VyJykpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy51c2VyLnNlbmRFbWFpbFZlcmlmaWNhdGlvbigpO1xuICB9XG5cbiAgYXN5bmMgc2lnbk91dCgpIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5hZmEuYXV0aC5zaWduT3V0KCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubm90aWZ5RXJyb3IoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgdGhlIHByb2ZpbGUgKG5hbWUgKyBwaG90byB1cmwpIG9mIHRoZSBhdXRoZW50aWNhdGVkIG5neC1hdXRoLWZpcmViYXNldWktdXNlciBpbiB0aGVcbiAgICogZmlyZWJhc2UgYXV0aGVudGljYXRpb24gZmVhdHVyZSAobm90IGluIGZpcmVzdG9yZSlcbiAgICpcbiAgICogQHBhcmFtIG5hbWUgLSB0aGUgbmV3IG5hbWUgb2YgdGhlIGF1dGhlbnRpY2F0ZWQgbmd4LWF1dGgtZmlyZWJhc2V1aS11c2VyXG4gICAqIEBwYXJhbSBwaG90b1VSTCAtIHRoZSBuZXcgcGhvdG8gdXJsIG9mIHRoZSBhdXRoZW50aWNhdGVkIG5neC1hdXRoLWZpcmViYXNldWktdXNlclxuICAgKiBAcmV0dXJucyAtXG4gICAqL1xuICBwdWJsaWMgdXBkYXRlUHJvZmlsZShuYW1lOiBzdHJpbmcsIHBob3RvVVJMOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIXBob3RvVVJMKSB7XG4gICAgICByZXR1cm4gdGhpcy5hZmEuYXV0aC5jdXJyZW50VXNlci51cGRhdGVQcm9maWxlKHtkaXNwbGF5TmFtZTogbmFtZX0pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5hZmEuYXV0aC5jdXJyZW50VXNlci51cGRhdGVQcm9maWxlKHtkaXNwbGF5TmFtZTogbmFtZSwgcGhvdG9VUkx9KTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZGVsZXRlQWNjb3VudCgpOiBQcm9taXNlPGFueT4ge1xuICAgIHJldHVybiB0aGlzLmFmYS5hdXRoLmN1cnJlbnRVc2VyLmRlbGV0ZSgpO1xuICB9XG5cbiAgcHVibGljIHBhcnNlVXNlckluZm8odXNlcjogVXNlcik6IFVzZXJJbmZvIHtcbiAgICByZXR1cm4ge1xuICAgICAgdWlkOiB1c2VyLnVpZCxcbiAgICAgIGRpc3BsYXlOYW1lOiB1c2VyLmRpc3BsYXlOYW1lLFxuICAgICAgZW1haWw6IHVzZXIuZW1haWwsXG4gICAgICBwaG9uZU51bWJlcjogdXNlci5waG9uZU51bWJlcixcbiAgICAgIHBob3RvVVJMOiB1c2VyLnBob3RvVVJMLFxuICAgICAgcHJvdmlkZXJJZDogdXNlci5wcm92aWRlckRhdGEubGVuZ3RoID4gMCA/IHVzZXIucHJvdmlkZXJEYXRhWzBdLnByb3ZpZGVySWQgOiBudWxsXG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRVc2VyUGhvdG9VcmwoKTogc3RyaW5nIHtcblxuICAgIGNvbnN0IHVzZXI6IGZpcmViYXNlLlVzZXIgfCBudWxsID0gdGhpcy5hZmEuYXV0aC5jdXJyZW50VXNlcjtcblxuICAgIGlmICghdXNlcikge1xuICAgICAgcmV0dXJuO1xuICAgIH0gZWxzZSBpZiAodXNlci5waG90b1VSTCkge1xuICAgICAgcmV0dXJuIHVzZXIucGhvdG9VUkw7XG4gICAgfSBlbHNlIGlmICh1c2VyLmVtYWlsVmVyaWZpZWQpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldFBob3RvUGF0aChBY2NvdW50cy5DSEVDSyk7XG4gICAgfSBlbHNlIGlmICh1c2VyLmlzQW5vbnltb3VzKSB7XG4gICAgICByZXR1cm4gdGhpcy5nZXRQaG90b1BhdGgoQWNjb3VudHMuT0ZGKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0UGhvdG9QYXRoKEFjY291bnRzLk5PTkUpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXRQaG90b1BhdGgoaW1hZ2U6IHN0cmluZykge1xuICAgIHJldHVybiBgYXNzZXRzL3VzZXIvJHtpbWFnZX0uc3ZnYDtcbiAgfVxuXG4gIHB1YmxpYyBzaWduSW5XaXRoUGhvbmVOdW1iZXIoKSB7XG4gICAgLy8gdG9kbzogMy4xLjE4XG4gIH1cblxuICBhc3luYyBoYW5kbGVTdWNjZXNzKHVzZXJDcmVkZW50aWFsOiBVc2VyQ3JlZGVudGlhbCkge1xuICAgIHRoaXMub25TdWNjZXNzRW1pdHRlci5uZXh0KHVzZXJDcmVkZW50aWFsLnVzZXIpO1xuICAgIGlmICh0aGlzLmNvbmZpZy5lbmFibGVGaXJlc3RvcmVTeW5jKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLmZpcmVTdG9yZVNlcnZpY2UudXBkYXRlVXNlckRhdGEodGhpcy5wYXJzZVVzZXJJbmZvKHVzZXJDcmVkZW50aWFsLnVzZXIpKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgRXJyb3Igb2NjdXJyZWQgd2hpbGUgdXBkYXRpbmcgdXNlciBkYXRhIHdpdGggZmlyZXN0b3JlOiAke2V9YCk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLmNvbmZpZy50b2FzdE1lc3NhZ2VPbkF1dGhTdWNjZXNzKSB7XG4gICAgICBjb25zdCBmYWxsYmFja01lc3NhZ2UgPSBgSGVsbG8gJHt1c2VyQ3JlZGVudGlhbC51c2VyLmRpc3BsYXlOYW1lID8gdXNlckNyZWRlbnRpYWwudXNlci5kaXNwbGF5TmFtZSA6ICcnfSFgO1xuICAgICAgdGhpcy5zaG93VG9hc3QodGhpcy5tZXNzYWdlT25BdXRoU3VjY2VzcyB8fCBmYWxsYmFja01lc3NhZ2UpO1xuICAgIH1cbiAgfVxuXG4gIGhhbmRsZUVycm9yKGVycm9yOiBhbnkpIHtcbiAgICB0aGlzLm5vdGlmeUVycm9yKGVycm9yKTtcbiAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgfVxuXG4gIC8vIFJlZnJlc2ggdXNlciBpbmZvLiBDYW4gYmUgdXNlZnVsIGZvciBpbnN0YW5jZSB0byBnZXQgbGF0ZXN0IHN0YXR1cyByZWdhcmRpbmcgZW1haWwgdmVyaWZpY2F0aW9uLlxuICByZWxvYWRVc2VySW5mbygpIHtcbiAgICByZXR1cm4gdGhpcy51c2VyLnJlbG9hZCgpO1xuICB9XG5cbiAgLy8gU2VhcmNoIGZvciBhbiBlcnJvciBtZXNzYWdlLlxuICAvLyBDb25zdW1lcnMgb2YgdGhpcyBsaWJyYXJ5IGFyZSBnaXZlbiB0aGUgcG9zc2liaWxpdHkgdG8gcHJvdmlkZSBhXG4gIC8vIGZ1bmN0aW9uIGluIGNhc2UgdGhleSB3YW50IHRvIGluc3RydW1lbnQgbWVzc2FnZSBiYXNlZCBvbiBlcnJvciBwcm9wZXJ0aWVzLlxuICBnZXRNZXNzYWdlT25BdXRoRXJyb3IoZXJyb3I6IGFueSkge1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1iaXR3aXNlXG4gICAgcmV0dXJuIGVycm9yLnRvU3RyaW5nKCkgfHwgJ1NvcnJ5LCBzb21ldGhpbmcgd2VudCB3cm9uZy4gUGxlYXNlIHJldHJ5IGxhdGVyLic7XG4gIH1cblxuICAvLyBTaG93IGEgdG9hc3QgdXNpbmcgY3VycmVudCBzbmFja2JhciBjb25maWcuIElmIG1lc3NhZ2UgaXMgZW1wdHksIG5vIHRvYXN0IGlzIGRpc3BsYXllZCBhbGxvd2luZyB0byBvcHQtb3V0IHdoZW4gbmVlZGVkLlxuICAvLyBEZWZhdWx0IE1hdFNuYWNrQmFyQ29uZmlnIGhhcyBubyBkdXJhdGlvbiwgbWVhbmluZyBpdCBzdGF5cyB2aXNpYmxlIGZvcmV2ZXIuXG4gIC8vIElmIHRoYXQncyB0aGUgY2FzZSwgYW4gYWN0aW9uIGJ1dHRvbiBpcyBhZGRlZCB0byBhbGxvdyB0aGUgZW5kLXVzZXIgdG8gZGlzbWlzcyB0aGUgdG9hc3QuXG4gIHNob3dUb2FzdChtZXNzYWdlOiBzdHJpbmcpIHtcbiAgICBpZiAobWVzc2FnZSkge1xuICAgICAgdGhpcy5zbmFja0Jhci5vcGVuKG1lc3NhZ2UsIHRoaXMubWF0U25hY2tCYXJDb25maWcuZHVyYXRpb24gPyBudWxsIDogJ09LJyk7XG4gICAgfVxuICB9XG5cbiAgc2hvd0Vycm9yVG9hc3QoZXJyb3I6IGFueSkge1xuICAgIGlmICh0aGlzLmNvbmZpZy50b2FzdE1lc3NhZ2VPbkF1dGhFcnJvcikge1xuICAgICAgdGhpcy5zaG93VG9hc3QodGhpcy5nZXRNZXNzYWdlT25BdXRoRXJyb3IoZXJyb3IpKTtcbiAgICB9XG4gIH1cblxuICBub3RpZnlFcnJvcihlcnJvcjogYW55KSB7XG4gICAgdGhpcy5vbkVycm9yRW1pdHRlci5lbWl0KGVycm9yKTtcbiAgICB0aGlzLnNob3dFcnJvclRvYXN0KGVycm9yKTtcbiAgfVxuXG59XG4iXX0=