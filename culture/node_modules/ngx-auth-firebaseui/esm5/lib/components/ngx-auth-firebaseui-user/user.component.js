import { __awaiter, __decorate, __generator, __param } from "tslib";
import { Component, EventEmitter, forwardRef, Inject, Input, Output } from '@angular/core';
import { AngularFireAuth } from '@angular/fire/auth';
import { FormControl, FormGroup, Validators } from '@angular/forms';
import { AuthProcessService } from '../../services';
import { FirestoreSyncService } from '../../services';
import { EMAIL_REGEX, PHONE_NUMBER_REGEX } from '..';
import { NgxAuthFirebaseUIConfigToken } from '../../tokens';
var UserComponent = /** @class */ (function () {
    function UserComponent(auth, authProcess, fireStoreService, config) {
        this.auth = auth;
        this.authProcess = authProcess;
        this.fireStoreService = fireStoreService;
        this.config = config;
        this.canLogout = true;
        this.canEditAccount = true;
        this.canDeleteAccount = true;
        // tslint:disable-next-line:no-output-on-prefix
        this.onSignOut = new EventEmitter();
        // tslint:disable-next-line:no-output-on-prefix
        this.onAccountEdited = new EventEmitter();
        // tslint:disable-next-line:no-output-on-prefix
        this.onAccountDeleted = new EventEmitter();
    }
    UserComponent.prototype.changeEditMode = function () {
        this.editMode = !this.editMode;
        this.editMode ? this.initUpdateFormGroup() : this.reset();
    };
    UserComponent.prototype.reset = function () {
        this.updateFormGroup.reset();
        this.updateFormGroup.disable();
        this.updateFormGroup = null;
    };
    UserComponent.prototype.save = function () {
        return __awaiter(this, void 0, void 0, function () {
            var user, snackBarMsg, error_1;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!this.updateFormGroup.dirty) return [3 /*break*/, 12];
                        user = this.auth.auth.currentUser;
                        snackBarMsg = [];
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 10, , 11]);
                        if (!this.updateNameFormControl.dirty) return [3 /*break*/, 3];
                        return [4 /*yield*/, user.updateProfile({ displayName: this.updateNameFormControl.value })];
                    case 2:
                        _a.sent();
                        snackBarMsg.push("your name has been updated to " + user.displayName);
                        _a.label = 3;
                    case 3:
                        if (!this.updateEmailFormControl.dirty) return [3 /*break*/, 5];
                        return [4 /*yield*/, user.updateEmail(this.updateEmailFormControl.value)];
                    case 4:
                        _a.sent();
                        snackBarMsg.push("your email has been updated to " + user.email);
                        _a.label = 5;
                    case 5:
                        if (!this.updatePhoneNumberFormControl.dirty) return [3 /*break*/, 7];
                        return [4 /*yield*/, user.updatePhoneNumber(this.updatePhoneNumberFormControl.value)];
                    case 6:
                        _a.sent();
                        console.log('phone number = ', this.updatePhoneNumberFormControl.value);
                        snackBarMsg.push("your phone number has been updated to " + user.phoneNumber);
                        _a.label = 7;
                    case 7:
                        if (!this.config.enableFirestoreSync) return [3 /*break*/, 9];
                        return [4 /*yield*/, this.fireStoreService.updateUserData(this.authProcess.parseUserInfo(user))];
                    case 8:
                        _a.sent();
                        _a.label = 9;
                    case 9: return [3 /*break*/, 11];
                    case 10:
                        error_1 = _a.sent();
                        this.authProcess.showToast(error_1 && error_1.message ? error_1.message : error_1);
                        console.error(error_1);
                        return [3 /*break*/, 11];
                    case 11:
                        if (snackBarMsg.length > 0) {
                            this.authProcess.showToast(snackBarMsg.join('\\n'));
                        }
                        _a.label = 12;
                    case 12:
                        this.editMode = false;
                        return [2 /*return*/];
                }
            });
        });
    };
    UserComponent.prototype.signOut = function () {
        var _this = this;
        this.auth.auth.signOut()
            .then(function () { return _this.onSignOut.emit(); })
            .catch(function (e) { return console.error('An error happened while signing out!', e); });
    };
    /**
     * Delete the account of the current firebase ngx-auth-firebaseui-user
     *
     * On Success, emit the <onAccountDeleted> event and toast a msg!#
     * Otherwise, log the and toast and error msg!
     *
     */
    UserComponent.prototype.deleteAccount = function () {
        return __awaiter(this, void 0, void 0, function () {
            var user, error_2;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 3, , 4]);
                        user = this.auth.auth.currentUser;
                        // await this.authProcess.deleteAccount();
                        return [4 /*yield*/, this.auth.auth.currentUser.delete()];
                    case 1:
                        // await this.authProcess.deleteAccount();
                        _a.sent();
                        // if (this.config.enableFirestoreSync) {
                        return [4 /*yield*/, this.fireStoreService.deleteUserData(user.uid)];
                    case 2:
                        // if (this.config.enableFirestoreSync) {
                        _a.sent();
                        // }
                        this.onAccountDeleted.emit();
                        this.editMode = false;
                        console.log('Your account has been successfully deleted!');
                        this.authProcess.showToast('Your account has been successfully deleted!');
                        return [3 /*break*/, 4];
                    case 3:
                        error_2 = _a.sent();
                        console.log('Error while delete user account', error_2);
                        this.authProcess.showToast("Error occurred while deleting your account: " + error_2.message);
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    UserComponent.prototype.initUpdateFormGroup = function () {
        var currentUser = this.auth.auth.currentUser;
        this.updateFormGroup = new FormGroup({
            name: this.updateNameFormControl = new FormControl({ value: currentUser.displayName, disabled: this.editMode }, [
                Validators.required,
                Validators.minLength(this.config.nameMinLength),
                Validators.maxLength(this.config.nameMaxLength)
            ]),
            email: this.updateEmailFormControl = new FormControl({ value: currentUser.email, disabled: this.editMode }, [
                Validators.required,
                Validators.pattern(EMAIL_REGEX)
            ]),
            phoneNumber: this.updatePhoneNumberFormControl = new FormControl({ value: currentUser.phoneNumber, disabled: this.editMode }, [Validators.pattern(PHONE_NUMBER_REGEX)])
        });
        this.updateFormGroup.enable();
    };
    UserComponent.ctorParameters = function () { return [
        { type: AngularFireAuth },
        { type: AuthProcessService },
        { type: FirestoreSyncService },
        { type: undefined, decorators: [{ type: Inject, args: [forwardRef(function () { return NgxAuthFirebaseUIConfigToken; }),] }] }
    ]; };
    __decorate([
        Input()
    ], UserComponent.prototype, "editMode", void 0);
    __decorate([
        Input()
    ], UserComponent.prototype, "canLogout", void 0);
    __decorate([
        Input()
    ], UserComponent.prototype, "canEditAccount", void 0);
    __decorate([
        Input()
    ], UserComponent.prototype, "canDeleteAccount", void 0);
    __decorate([
        Input()
    ], UserComponent.prototype, "appearance", void 0);
    __decorate([
        Output()
    ], UserComponent.prototype, "onSignOut", void 0);
    __decorate([
        Output()
    ], UserComponent.prototype, "onAccountEdited", void 0);
    __decorate([
        Output()
    ], UserComponent.prototype, "onAccountDeleted", void 0);
    UserComponent = __decorate([
        Component({
            selector: 'ngx-auth-firebaseui-user',
            template: "<div *ngIf=\"auth.authState| async as user; then authenticated else none\">\n\n</div>\n\n<ng-template #authenticated>\n  <mat-card *ngIf=\"auth.user | async as user\">\n    <!--<form [formGroup]=\"updateFormGroup\" >-->\n    <!--card header-->\n    <mat-card-header fxLayout=\"column\" fxLayoutAlign=\"center center\">\n\n      <img [src]=\"authProcess?.getUserPhotoUrl()\" mat-card-avatar>\n\n      <div *ngIf=\"user.emailVerified; then emailVerified else emailNotVerified\"></div>\n      <ng-template #emailVerified>\n        <mat-icon color=\"primary\"\n                  matTooltip=\"email is verified\"\n                  matTooltipPosition=\"after\">\n          verified_user\n        </mat-icon>\n      </ng-template>\n      <ng-template #emailNotVerified>\n        <mat-icon color=\"warn\"\n                  matTooltip=\"email is not verified\"\n                  matTooltipPosition=\"after\">\n          warning\n        </mat-icon>\n      </ng-template>\n\n    </mat-card-header>\n\n    <!--card content-->\n    <mat-card-content *ngIf=\"editMode; then edit else readonly\">\n    </mat-card-content>\n\n    <ng-template #edit>\n      <form (submit)=\"save()\" [formGroup]=\"updateFormGroup\">\n\n        <mat-card-content fxLayout=\"column\" fxLayoutAlign=\"center center\">\n          <div fxLayoutAlign=\"center\">\n            <button (click)=\"changeEditMode()\" class=\"edit-button\" color=\"warn\"\n                    mat-raised-button>\n              cancel\n            </button>\n          </div>\n\n          <!--name-->\n          <mat-form-field [appearance]=\"appearance\" class=\"full-width\">\n            <mat-label>Name</mat-label>\n            <input [formControl]=\"updateNameFormControl\"\n                   matInput\n                   placeholder=\"Name\">\n            <mat-icon matSuffix>person</mat-icon>\n            <mat-hint align=\"end\" aria-live=\"polite\"> {{ updateNameFormControl.value?.length }}\n              / {{ config.nameMaxLength }} </mat-hint>\n            <mat-error *ngIf=\"updateNameFormControl.hasError('required')\">\n              Name is required\n            </mat-error>\n          </mat-form-field>\n\n          <!--email-->\n          <mat-form-field [appearance]=\"appearance\" class=\"full-width\">\n            <mat-label>E-mail</mat-label>\n            <input [formControl]=\"updateEmailFormControl\"\n                   matInput\n                   placeholder=\"E-mail\">\n            <mat-icon matSuffix>email</mat-icon>\n            <mat-error *ngIf=\"updateEmailFormControl.hasError('required')\">\n              E-mail is required {{updateEmailFormControl.value}}\n            </mat-error>\n            <mat-error *ngIf=\"updateEmailFormControl.hasError('pattern')\">\n              Please enter a valid e-mail address {{updateEmailFormControl.value}}\n            </mat-error>\n          </mat-form-field>\n\n          <!--phone number-->\n          <mat-form-field *ngIf=\"false\" [appearance]=\"appearance\" class=\"full-width\">\n            <mat-label>Phone number</mat-label>\n            <input [formControl]=\"updatePhoneNumberFormControl\"\n                   matInput\n                   placeholder=\"Phone number\"\n                   type=\"tel\">\n            <mat-icon matSuffix>phone</mat-icon>\n            <mat-hint align=\"end\" aria-live=\"polite\">\n              The phone number is international. Therefore, it should start with a + sign or 00,\n              followed by the country code, - and national number e.g: +49-12345678 or 0041-1234567890\n\n              NOTE : the phone number must be a valid phone credential !!\n            </mat-hint>\n            <mat-error *ngIf=\"updatePhoneNumberFormControl.hasError('pattern')\">\n              Please enter a valid phone number\n            </mat-error>\n          </mat-form-field>\n\n        </mat-card-content>\n\n        <mat-card-actions fxLayout=\"column\">\n          <button color=\"primary\"\n                  mat-button\n                  type=\"submit\">\n            Save changes\n          </button>\n        </mat-card-actions>\n      </form>\n    </ng-template>\n\n    <ng-template #readonly>\n      <div fxLayoutAlign=\"center\">\n        <button (click)=\"changeEditMode()\" class=\"edit-button\" color=\"primary\"\n                mat-raised-button>\n          edit\n        </button>\n      </div>\n\n      <!--name-->\n      <mat-form-field [appearance]=\"appearance\" class=\"full-width\">\n        <mat-label>Name</mat-label>\n        <input [disabled]=\"!editMode\"\n               [value]=\"user.displayName\"\n               matInput\n               placeholder=\"Name\">\n        <mat-icon color=\"primary\" matSuffix>person</mat-icon>\n      </mat-form-field>\n\n      <!--email-->\n      <mat-form-field [appearance]=\"appearance\" class=\"full-width\">\n        <mat-label>E-mail</mat-label>\n        <input [disabled]=\"!editMode\"\n               [value]=\"user.email\" matInput\n               placeholder=\"E-mail\">\n        <mat-icon color=\"primary\" matSuffix>email</mat-icon>\n      </mat-form-field>\n\n      <!--phone number-->\n      <mat-form-field *ngIf=\"false\" [appearance]=\"appearance\" class=\"full-width\">\n        <mat-label>Phone number</mat-label>\n        <input [disabled]=\"!editMode\"\n               [value]=\"user.phoneNumber\"\n               matInput\n               placeholder=\"Phone number\">\n        <mat-icon color=\"primary\" matSuffix>phone</mat-icon>\n      </mat-form-field>\n\n      <mat-card-actions fxLayout=\"column\">\n        <button (click)=\"signOut()\" *ngIf=\"canLogout\" color=\"primary\" mat-button>Sign out</button>\n        <button (click)=\"deleteAccount()\" *ngIf=\"canDeleteAccount\" color=\"warn\" mat-button>Delete account</button>\n      </mat-card-actions>\n\n    </ng-template>\n\n  </mat-card>\n\n</ng-template>\n\n\n<ng-template #none>\n  <mat-card class=\"none-card\" fxLayout=\"row\" fxLayoutAlign=\"center center\">\n    <mat-card-content fxLayout=\"row\" fxLayoutAlign=\"center center\">\n      <mat-icon color=\"accent\">warning</mat-icon>\n      <span>You are not logged in!</span>\n    </mat-card-content>\n  </mat-card>\n</ng-template>\n",
            styles: [".edit-button{margin:1rem}.full-width{width:100%}.cut-text{text-overflow:ellipsis;overflow:hidden;white-space:nowrap}.none-card{min-height:430px}.none-card span{font-size:24px;text-align:center;color:rgba(0,0,0,.54)}"]
        }),
        __param(3, Inject(forwardRef(function () { return NgxAuthFirebaseUIConfigToken; })))
    ], UserComponent);
    return UserComponent;
}());
export { UserComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtYXV0aC1maXJlYmFzZXVpLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvbmd4LWF1dGgtZmlyZWJhc2V1aS11c2VyL3VzZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUMsU0FBUyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDekYsT0FBTyxFQUFDLGVBQWUsRUFBQyxNQUFNLG9CQUFvQixDQUFDO0FBQ25ELE9BQU8sRUFBQyxXQUFXLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBRWxFLE9BQU8sRUFBQyxrQkFBa0IsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ2xELE9BQU8sRUFBQyxvQkFBb0IsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ3BELE9BQU8sRUFBQyxXQUFXLEVBQUUsa0JBQWtCLEVBQUMsTUFBTSxJQUFJLENBQUM7QUFFbkQsT0FBTyxFQUFDLDRCQUE0QixFQUFDLE1BQU0sY0FBYyxDQUFDO0FBUTFEO0lBbUNFLHVCQUNTLElBQXFCLEVBQ3JCLFdBQStCLEVBQzlCLGdCQUFzQyxFQUNpQixNQUErQjtRQUh2RixTQUFJLEdBQUosSUFBSSxDQUFpQjtRQUNyQixnQkFBVyxHQUFYLFdBQVcsQ0FBb0I7UUFDOUIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFzQjtRQUNpQixXQUFNLEdBQU4sTUFBTSxDQUF5QjtRQWpDaEcsY0FBUyxHQUFHLElBQUksQ0FBQztRQUdqQixtQkFBYyxHQUFHLElBQUksQ0FBQztRQUd0QixxQkFBZ0IsR0FBRyxJQUFJLENBQUM7UUFLeEIsK0NBQStDO1FBRS9DLGNBQVMsR0FBdUIsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUVuRCwrQ0FBK0M7UUFFL0Msb0JBQWUsR0FBdUIsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUV6RCwrQ0FBK0M7UUFFL0MscUJBQWdCLEdBQXVCLElBQUksWUFBWSxFQUFFLENBQUM7SUFjMUQsQ0FBQztJQUVELHNDQUFjLEdBQWQ7UUFDRSxJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUUvQixJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQzVELENBQUM7SUFFRCw2QkFBSyxHQUFMO1FBQ0UsSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUM3QixJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQy9CLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDO0lBQzlCLENBQUM7SUFFSyw0QkFBSSxHQUFWOzs7Ozs7NkJBQ00sSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQTFCLHlCQUEwQjt3QkFDdEIsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQzt3QkFLbEMsV0FBVyxHQUFhLEVBQUUsQ0FBQzs7Ozs2QkFHM0IsSUFBSSxDQUFDLHFCQUFxQixDQUFDLEtBQUssRUFBaEMsd0JBQWdDO3dCQUNsQyxxQkFBTSxJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLEVBQUMsQ0FBQyxFQUFBOzt3QkFBekUsU0FBeUUsQ0FBQzt3QkFDMUUsV0FBVyxDQUFDLElBQUksQ0FBQyxtQ0FBaUMsSUFBSSxDQUFDLFdBQWEsQ0FBQyxDQUFDOzs7NkJBR3BFLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxLQUFLLEVBQWpDLHdCQUFpQzt3QkFDbkMscUJBQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsS0FBSyxDQUFDLEVBQUE7O3dCQUF6RCxTQUF5RCxDQUFDO3dCQUMxRCxXQUFXLENBQUMsSUFBSSxDQUFDLG9DQUFrQyxJQUFJLENBQUMsS0FBTyxDQUFDLENBQUM7Ozs2QkFHL0QsSUFBSSxDQUFDLDRCQUE0QixDQUFDLEtBQUssRUFBdkMsd0JBQXVDO3dCQUN6QyxxQkFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLDRCQUE0QixDQUFDLEtBQUssQ0FBQyxFQUFBOzt3QkFBckUsU0FBcUUsQ0FBQzt3QkFDdEUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRSxJQUFJLENBQUMsNEJBQTRCLENBQUMsS0FBSyxDQUFDLENBQUM7d0JBQ3hFLFdBQVcsQ0FBQyxJQUFJLENBQUMsMkNBQXlDLElBQUksQ0FBQyxXQUFhLENBQUMsQ0FBQzs7OzZCQUc1RSxJQUFJLENBQUMsTUFBTSxDQUFDLG1CQUFtQixFQUEvQix3QkFBK0I7d0JBQ2pDLHFCQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBQTs7d0JBQWhGLFNBQWdGLENBQUM7Ozs7O3dCQUluRixJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxPQUFLLElBQUksT0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBSyxDQUFDLENBQUM7d0JBQzNFLE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBSyxDQUFDLENBQUM7Ozt3QkFJdkIsSUFBSSxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTs0QkFDMUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO3lCQUNyRDs7O3dCQUlILElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDOzs7OztLQUN2QjtJQUVELCtCQUFPLEdBQVA7UUFBQSxpQkFJQztRQUhDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRTthQUNyQixJQUFJLENBQUMsY0FBTSxPQUFBLEtBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLEVBQXJCLENBQXFCLENBQUM7YUFDakMsS0FBSyxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsT0FBTyxDQUFDLEtBQUssQ0FBQyxzQ0FBc0MsRUFBRSxDQUFDLENBQUMsRUFBeEQsQ0FBd0QsQ0FBQyxDQUFDO0lBQzFFLENBQUM7SUFFRDs7Ozs7O09BTUc7SUFDRyxxQ0FBYSxHQUFuQjs7Ozs7Ozt3QkFFVSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDO3dCQUV4QywwQ0FBMEM7d0JBQzFDLHFCQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsRUFBQTs7d0JBRHpDLDBDQUEwQzt3QkFDMUMsU0FBeUMsQ0FBQzt3QkFDMUMseUNBQXlDO3dCQUN6QyxxQkFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBQTs7d0JBRHBELHlDQUF5Qzt3QkFDekMsU0FBb0QsQ0FBQzt3QkFDckQsSUFBSTt3QkFDSixJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLENBQUM7d0JBQzdCLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO3dCQUN0QixPQUFPLENBQUMsR0FBRyxDQUFDLDZDQUE2QyxDQUFDLENBQUM7d0JBQzNELElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLDZDQUE2QyxDQUFDLENBQUM7Ozs7d0JBRTFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUNBQWlDLEVBQUUsT0FBSyxDQUFDLENBQUM7d0JBQ3RELElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLGlEQUErQyxPQUFLLENBQUMsT0FBUyxDQUFDLENBQUM7Ozs7OztLQUU5RjtJQUVTLDJDQUFtQixHQUE3QjtRQUNFLElBQU0sV0FBVyxHQUFTLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQztRQUNyRCxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksU0FBUyxDQUFDO1lBQ25DLElBQUksRUFBRSxJQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSxXQUFXLENBQ2hELEVBQUMsS0FBSyxFQUFFLFdBQVcsQ0FBQyxXQUFXLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUMsRUFDekQ7Z0JBQ0UsVUFBVSxDQUFDLFFBQVE7Z0JBQ25CLFVBQVUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUM7Z0JBQy9DLFVBQVUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUM7YUFDaEQsQ0FDRjtZQUVELEtBQUssRUFBRSxJQUFJLENBQUMsc0JBQXNCLEdBQUcsSUFBSSxXQUFXLENBQ2xELEVBQUMsS0FBSyxFQUFFLFdBQVcsQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUMsRUFDbkQ7Z0JBQ0UsVUFBVSxDQUFDLFFBQVE7Z0JBQ25CLFVBQVUsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDO2FBQ2hDLENBQUM7WUFFSixXQUFXLEVBQUUsSUFBSSxDQUFDLDRCQUE0QixHQUFHLElBQUksV0FBVyxDQUM5RCxFQUFDLEtBQUssRUFBRSxXQUFXLENBQUMsV0FBVyxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFDLEVBQ3pELENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUM7U0FDNUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUNoQyxDQUFDOztnQkF6SGMsZUFBZTtnQkFDUixrQkFBa0I7Z0JBQ1osb0JBQW9CO2dEQUM3QyxNQUFNLFNBQUMsVUFBVSxDQUFDLGNBQU0sT0FBQSw0QkFBNEIsRUFBNUIsQ0FBNEIsQ0FBQzs7SUFwQ3hEO1FBREMsS0FBSyxFQUFFO21EQUNVO0lBR2xCO1FBREMsS0FBSyxFQUFFO29EQUNTO0lBR2pCO1FBREMsS0FBSyxFQUFFO3lEQUNjO0lBR3RCO1FBREMsS0FBSyxFQUFFOzJEQUNnQjtJQUd4QjtRQURDLEtBQUssRUFBRTtxREFDMkI7SUFJbkM7UUFEQyxNQUFNLEVBQUU7b0RBQzBDO0lBSW5EO1FBREMsTUFBTSxFQUFFOzBEQUNnRDtJQUl6RDtRQURDLE1BQU0sRUFBRTsyREFDaUQ7SUEzQi9DLGFBQWE7UUFMekIsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLDBCQUEwQjtZQUNwQyxta01BQW9DOztTQUVyQyxDQUFDO1FBd0NHLFdBQUEsTUFBTSxDQUFDLFVBQVUsQ0FBQyxjQUFNLE9BQUEsNEJBQTRCLEVBQTVCLENBQTRCLENBQUMsQ0FBQyxDQUFBO09BdkM5QyxhQUFhLENBOEp6QjtJQUFELG9CQUFDO0NBQUEsQUE5SkQsSUE4SkM7U0E5SlksYUFBYSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29tcG9uZW50LCBFdmVudEVtaXR0ZXIsIGZvcndhcmRSZWYsIEluamVjdCwgSW5wdXQsIE91dHB1dH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0FuZ3VsYXJGaXJlQXV0aH0gZnJvbSAnQGFuZ3VsYXIvZmlyZS9hdXRoJztcbmltcG9ydCB7Rm9ybUNvbnRyb2wsIEZvcm1Hcm91cCwgVmFsaWRhdG9yc30gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHtVc2VyfSBmcm9tICdmaXJlYmFzZSc7XG5pbXBvcnQge0F1dGhQcm9jZXNzU2VydmljZX0gZnJvbSAnLi4vLi4vc2VydmljZXMnO1xuaW1wb3J0IHtGaXJlc3RvcmVTeW5jU2VydmljZX0gZnJvbSAnLi4vLi4vc2VydmljZXMnO1xuaW1wb3J0IHtFTUFJTF9SRUdFWCwgUEhPTkVfTlVNQkVSX1JFR0VYfSBmcm9tICcuLic7XG5pbXBvcnQge01hdEZvcm1GaWVsZEFwcGVhcmFuY2V9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL2Zvcm0tZmllbGQnO1xuaW1wb3J0IHtOZ3hBdXRoRmlyZWJhc2VVSUNvbmZpZ1Rva2VufSBmcm9tICcuLi8uLi90b2tlbnMnO1xuaW1wb3J0IHtOZ3hBdXRoRmlyZWJhc2VVSUNvbmZpZ30gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcyc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ25neC1hdXRoLWZpcmViYXNldWktdXNlcicsXG4gIHRlbXBsYXRlVXJsOiAnLi91c2VyLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vdXNlci5jb21wb25lbnQuc2NzcyddXG59KVxuZXhwb3J0IGNsYXNzIFVzZXJDb21wb25lbnQge1xuXG4gIEBJbnB1dCgpXG4gIGVkaXRNb2RlOiBib29sZWFuO1xuXG4gIEBJbnB1dCgpXG4gIGNhbkxvZ291dCA9IHRydWU7XG5cbiAgQElucHV0KClcbiAgY2FuRWRpdEFjY291bnQgPSB0cnVlO1xuXG4gIEBJbnB1dCgpXG4gIGNhbkRlbGV0ZUFjY291bnQgPSB0cnVlO1xuXG4gIEBJbnB1dCgpXG4gIGFwcGVhcmFuY2U6IE1hdEZvcm1GaWVsZEFwcGVhcmFuY2U7XG5cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLW91dHB1dC1vbi1wcmVmaXhcbiAgQE91dHB1dCgpXG4gIG9uU2lnbk91dDogRXZlbnRFbWl0dGVyPHZvaWQ+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1vdXRwdXQtb24tcHJlZml4XG4gIEBPdXRwdXQoKVxuICBvbkFjY291bnRFZGl0ZWQ6IEV2ZW50RW1pdHRlcjx2b2lkPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tb3V0cHV0LW9uLXByZWZpeFxuICBAT3V0cHV0KClcbiAgb25BY2NvdW50RGVsZXRlZDogRXZlbnRFbWl0dGVyPHZvaWQ+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIHVwZGF0ZUZvcm1Hcm91cDogRm9ybUdyb3VwO1xuICB1cGRhdGVOYW1lRm9ybUNvbnRyb2w6IEZvcm1Db250cm9sO1xuICB1cGRhdGVFbWFpbEZvcm1Db250cm9sOiBGb3JtQ29udHJvbDtcbiAgdXBkYXRlUGhvbmVOdW1iZXJGb3JtQ29udHJvbDogRm9ybUNvbnRyb2w7XG4gIHVwZGF0ZVBhc3N3b3JkRm9ybUNvbnRyb2w6IEZvcm1Db250cm9sO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBhdXRoOiBBbmd1bGFyRmlyZUF1dGgsXG4gICAgcHVibGljIGF1dGhQcm9jZXNzOiBBdXRoUHJvY2Vzc1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBmaXJlU3RvcmVTZXJ2aWNlOiBGaXJlc3RvcmVTeW5jU2VydmljZSxcbiAgICBASW5qZWN0KGZvcndhcmRSZWYoKCkgPT4gTmd4QXV0aEZpcmViYXNlVUlDb25maWdUb2tlbikpIHB1YmxpYyBjb25maWc6IE5neEF1dGhGaXJlYmFzZVVJQ29uZmlnXG4gICkge1xuICB9XG5cbiAgY2hhbmdlRWRpdE1vZGUoKSB7XG4gICAgdGhpcy5lZGl0TW9kZSA9ICF0aGlzLmVkaXRNb2RlO1xuXG4gICAgdGhpcy5lZGl0TW9kZSA/IHRoaXMuaW5pdFVwZGF0ZUZvcm1Hcm91cCgpIDogdGhpcy5yZXNldCgpO1xuICB9XG5cbiAgcmVzZXQoKSB7XG4gICAgdGhpcy51cGRhdGVGb3JtR3JvdXAucmVzZXQoKTtcbiAgICB0aGlzLnVwZGF0ZUZvcm1Hcm91cC5kaXNhYmxlKCk7XG4gICAgdGhpcy51cGRhdGVGb3JtR3JvdXAgPSBudWxsO1xuICB9XG5cbiAgYXN5bmMgc2F2ZSgpIHtcbiAgICBpZiAodGhpcy51cGRhdGVGb3JtR3JvdXAuZGlydHkpIHtcbiAgICAgIGNvbnN0IHVzZXIgPSB0aGlzLmF1dGguYXV0aC5jdXJyZW50VXNlcjtcbiAgICAgIC8vIG5neC1hdXRoLWZpcmViYXNldWktdXNlci51cGRhdGVQcm9maWxlKClcbiAgICAgIC8vIG5neC1hdXRoLWZpcmViYXNldWktdXNlci51cGRhdGVFbWFpbCgpXG4gICAgICAvLyBjb25zb2xlLmxvZygnZm9ybSA9ICcsIHRoaXMudXBkYXRlRm9ybUdyb3VwKTtcblxuICAgICAgY29uc3Qgc25hY2tCYXJNc2c6IHN0cmluZ1tdID0gW107XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGlmICh0aGlzLnVwZGF0ZU5hbWVGb3JtQ29udHJvbC5kaXJ0eSkge1xuICAgICAgICAgIGF3YWl0IHVzZXIudXBkYXRlUHJvZmlsZSh7ZGlzcGxheU5hbWU6IHRoaXMudXBkYXRlTmFtZUZvcm1Db250cm9sLnZhbHVlfSk7XG4gICAgICAgICAgc25hY2tCYXJNc2cucHVzaChgeW91ciBuYW1lIGhhcyBiZWVuIHVwZGF0ZWQgdG8gJHt1c2VyLmRpc3BsYXlOYW1lfWApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMudXBkYXRlRW1haWxGb3JtQ29udHJvbC5kaXJ0eSkge1xuICAgICAgICAgIGF3YWl0IHVzZXIudXBkYXRlRW1haWwodGhpcy51cGRhdGVFbWFpbEZvcm1Db250cm9sLnZhbHVlKTtcbiAgICAgICAgICBzbmFja0Jhck1zZy5wdXNoKGB5b3VyIGVtYWlsIGhhcyBiZWVuIHVwZGF0ZWQgdG8gJHt1c2VyLmVtYWlsfWApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMudXBkYXRlUGhvbmVOdW1iZXJGb3JtQ29udHJvbC5kaXJ0eSkge1xuICAgICAgICAgIGF3YWl0IHVzZXIudXBkYXRlUGhvbmVOdW1iZXIodGhpcy51cGRhdGVQaG9uZU51bWJlckZvcm1Db250cm9sLnZhbHVlKTtcbiAgICAgICAgICBjb25zb2xlLmxvZygncGhvbmUgbnVtYmVyID0gJywgdGhpcy51cGRhdGVQaG9uZU51bWJlckZvcm1Db250cm9sLnZhbHVlKTtcbiAgICAgICAgICBzbmFja0Jhck1zZy5wdXNoKGB5b3VyIHBob25lIG51bWJlciBoYXMgYmVlbiB1cGRhdGVkIHRvICR7dXNlci5waG9uZU51bWJlcn1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmNvbmZpZy5lbmFibGVGaXJlc3RvcmVTeW5jKSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5maXJlU3RvcmVTZXJ2aWNlLnVwZGF0ZVVzZXJEYXRhKHRoaXMuYXV0aFByb2Nlc3MucGFyc2VVc2VySW5mbyh1c2VyKSk7XG4gICAgICAgIH1cblxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgdGhpcy5hdXRoUHJvY2Vzcy5zaG93VG9hc3QoZXJyb3IgJiYgZXJyb3IubWVzc2FnZSA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcik7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgfVxuXG5cbiAgICAgIGlmIChzbmFja0Jhck1zZy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHRoaXMuYXV0aFByb2Nlc3Muc2hvd1RvYXN0KHNuYWNrQmFyTXNnLmpvaW4oJ1xcXFxuJykpO1xuICAgICAgfVxuICAgICAgLy8gdGhpcy51cGRhdGVGb3JtR3JvdXAucmVzZXQoKTtcbiAgICB9XG5cbiAgICB0aGlzLmVkaXRNb2RlID0gZmFsc2U7XG4gIH1cblxuICBzaWduT3V0KCkge1xuICAgIHRoaXMuYXV0aC5hdXRoLnNpZ25PdXQoKVxuICAgICAgLnRoZW4oKCkgPT4gdGhpcy5vblNpZ25PdXQuZW1pdCgpKVxuICAgICAgLmNhdGNoKGUgPT4gY29uc29sZS5lcnJvcignQW4gZXJyb3IgaGFwcGVuZWQgd2hpbGUgc2lnbmluZyBvdXQhJywgZSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZSB0aGUgYWNjb3VudCBvZiB0aGUgY3VycmVudCBmaXJlYmFzZSBuZ3gtYXV0aC1maXJlYmFzZXVpLXVzZXJcbiAgICpcbiAgICogT24gU3VjY2VzcywgZW1pdCB0aGUgPG9uQWNjb3VudERlbGV0ZWQ+IGV2ZW50IGFuZCB0b2FzdCBhIG1zZyEjXG4gICAqIE90aGVyd2lzZSwgbG9nIHRoZSBhbmQgdG9hc3QgYW5kIGVycm9yIG1zZyFcbiAgICpcbiAgICovXG4gIGFzeW5jIGRlbGV0ZUFjY291bnQoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVzZXIgPSB0aGlzLmF1dGguYXV0aC5jdXJyZW50VXNlcjtcblxuICAgICAgLy8gYXdhaXQgdGhpcy5hdXRoUHJvY2Vzcy5kZWxldGVBY2NvdW50KCk7XG4gICAgICBhd2FpdCB0aGlzLmF1dGguYXV0aC5jdXJyZW50VXNlci5kZWxldGUoKTtcbiAgICAgIC8vIGlmICh0aGlzLmNvbmZpZy5lbmFibGVGaXJlc3RvcmVTeW5jKSB7XG4gICAgICBhd2FpdCB0aGlzLmZpcmVTdG9yZVNlcnZpY2UuZGVsZXRlVXNlckRhdGEodXNlci51aWQpO1xuICAgICAgLy8gfVxuICAgICAgdGhpcy5vbkFjY291bnREZWxldGVkLmVtaXQoKTtcbiAgICAgIHRoaXMuZWRpdE1vZGUgPSBmYWxzZTtcbiAgICAgIGNvbnNvbGUubG9nKCdZb3VyIGFjY291bnQgaGFzIGJlZW4gc3VjY2Vzc2Z1bGx5IGRlbGV0ZWQhJyk7XG4gICAgICB0aGlzLmF1dGhQcm9jZXNzLnNob3dUb2FzdCgnWW91ciBhY2NvdW50IGhhcyBiZWVuIHN1Y2Nlc3NmdWxseSBkZWxldGVkIScpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmxvZygnRXJyb3Igd2hpbGUgZGVsZXRlIHVzZXIgYWNjb3VudCcsIGVycm9yKTtcbiAgICAgIHRoaXMuYXV0aFByb2Nlc3Muc2hvd1RvYXN0KGBFcnJvciBvY2N1cnJlZCB3aGlsZSBkZWxldGluZyB5b3VyIGFjY291bnQ6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgaW5pdFVwZGF0ZUZvcm1Hcm91cCgpIHtcbiAgICBjb25zdCBjdXJyZW50VXNlcjogVXNlciA9IHRoaXMuYXV0aC5hdXRoLmN1cnJlbnRVc2VyO1xuICAgIHRoaXMudXBkYXRlRm9ybUdyb3VwID0gbmV3IEZvcm1Hcm91cCh7XG4gICAgICBuYW1lOiB0aGlzLnVwZGF0ZU5hbWVGb3JtQ29udHJvbCA9IG5ldyBGb3JtQ29udHJvbChcbiAgICAgICAge3ZhbHVlOiBjdXJyZW50VXNlci5kaXNwbGF5TmFtZSwgZGlzYWJsZWQ6IHRoaXMuZWRpdE1vZGV9LFxuICAgICAgICBbXG4gICAgICAgICAgVmFsaWRhdG9ycy5yZXF1aXJlZCxcbiAgICAgICAgICBWYWxpZGF0b3JzLm1pbkxlbmd0aCh0aGlzLmNvbmZpZy5uYW1lTWluTGVuZ3RoKSxcbiAgICAgICAgICBWYWxpZGF0b3JzLm1heExlbmd0aCh0aGlzLmNvbmZpZy5uYW1lTWF4TGVuZ3RoKVxuICAgICAgICBdXG4gICAgICApLFxuXG4gICAgICBlbWFpbDogdGhpcy51cGRhdGVFbWFpbEZvcm1Db250cm9sID0gbmV3IEZvcm1Db250cm9sKFxuICAgICAgICB7dmFsdWU6IGN1cnJlbnRVc2VyLmVtYWlsLCBkaXNhYmxlZDogdGhpcy5lZGl0TW9kZX0sXG4gICAgICAgIFtcbiAgICAgICAgICBWYWxpZGF0b3JzLnJlcXVpcmVkLFxuICAgICAgICAgIFZhbGlkYXRvcnMucGF0dGVybihFTUFJTF9SRUdFWClcbiAgICAgICAgXSksXG5cbiAgICAgIHBob25lTnVtYmVyOiB0aGlzLnVwZGF0ZVBob25lTnVtYmVyRm9ybUNvbnRyb2wgPSBuZXcgRm9ybUNvbnRyb2woXG4gICAgICAgIHt2YWx1ZTogY3VycmVudFVzZXIucGhvbmVOdW1iZXIsIGRpc2FibGVkOiB0aGlzLmVkaXRNb2RlfSxcbiAgICAgICAgW1ZhbGlkYXRvcnMucGF0dGVybihQSE9ORV9OVU1CRVJfUkVHRVgpXSlcbiAgICB9KTtcblxuICAgIHRoaXMudXBkYXRlRm9ybUdyb3VwLmVuYWJsZSgpO1xuICB9XG59XG4iXX0=